<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teacher Portal - –ö–∞–±—ñ–Ω–µ—Ç –≤–∏–∫–ª–∞–¥–∞—á–∞</title>
    <style>
        :root {
            --color-primary: #218d8d;
            --color-primary-hover: #1a7474;
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-text-light: #666;
            --color-border: #ddd;
            --color-success: #27ae60;
            --color-warning: #f39c12;
            --color-danger: #e74c3c;
            --color-info: #3498db;
            --spacing: 16px;
            --radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: var(--color-text);
            line-height: 1.6;
            background:
                radial-gradient(1200px 600px at 20% -10%, rgba(33, 141, 141, 0.18), transparent 55%),
                radial-gradient(900px 500px at 90% 10%, rgba(52, 152, 219, 0.12), transparent 55%),
                radial-gradient(900px 550px at 30% 110%, rgba(39, 174, 96, 0.10), transparent 55%),
                var(--color-bg);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: var(--spacing); }

        .auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background:
                radial-gradient(900px 600px at 15% 15%, rgba(255,255,255,0.20), transparent 55%),
                radial-gradient(700px 500px at 80% 30%, rgba(255,255,255,0.14), transparent 55%),
                linear-gradient(135deg, #1b9f9a 0%, #164e63 55%, #0f2a3a 100%);
        }

        .auth-screen::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                linear-gradient(rgba(255,255,255,0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.08) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.35;
            pointer-events: none;
        }

        .auth-form {
            position: relative;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 420px;
            border: 1px solid rgba(255,255,255,0.22);
            backdrop-filter: blur(10px);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(33,141,141,0.10), rgba(52,152,219,0.08));
            border: 1px solid rgba(0,0,0,0.06);
            margin-bottom: 14px;
        }
        .brand-mark {
            width: 42px;
            height: 42px;
            display: grid;
            place-items: center;
            border-radius: 12px;
            background: white;
            box-shadow: 0 8px 18px rgba(0,0,0,0.08);
            font-size: 20px;
        }
        .brand-title { font-weight: 800; letter-spacing: 0.2px; color: #0f172a; line-height: 1.1; }
        .brand-subtitle { font-size: 12px; color: var(--color-text-light); margin-top: 2px; }

        .auth-form h1 { font-size: 28px; margin-bottom: 10px; color: var(--color-primary); }
        .auth-form p { color: var(--color-text-light); margin-bottom: 18px; }

        .error-message {
            background: #fee;
            color: var(--color-danger);
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            font-size: 14px;
            border-left: 4px solid var(--color-danger);
        }

        .success-message {
            background: #efe;
            color: var(--color-success);
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            font-size: 14px;
            border-left: 4px solid var(--color-success);
        }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--color-text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
            background: #fff;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 10px 22px rgba(2, 6, 23, 0.12);
        }

        .btn-primary { background: var(--color-primary); color: white; }
        .btn-primary:hover { background: var(--color-primary-hover); transform: translateY(-1px); box-shadow: 0 14px 28px rgba(2, 6, 23, 0.16); }

        .toggle-link { text-align: center; margin-top: 20px; color: var(--color-text-light); }
        .toggle-link a { color: var(--color-primary); text-decoration: none; font-weight: 500; cursor: pointer; }

        .dashboard { display: none; min-height: 100vh; }
        .dashboard.active { display: block; }

        .header {
            background:
                radial-gradient(900px 500px at 20% -20%, rgba(33,141,141,0.16), transparent 60%),
                radial-gradient(700px 500px at 90% 20%, rgba(52,152,219,0.12), transparent 55%),
                #ffffff;
            padding: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 { color: var(--color-primary); font-size: 24px; }

        .user-info { display: flex; align-items: center; gap: 20px; }

        .role-badge {
            background: var(--color-primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .role-badge.admin { background: #8e44ad; }
        .role-badge.teacher { background: #2980b9; }
        .role-badge.student { background: #27ae60; }

        .btn-logout {
            padding: 10px 20px;
            background: var(--color-danger);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-logout:hover { background: #c0392b; }

        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 10px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            background: rgba(33,141,141,0.08);
            border-radius: 10px;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* scoped tabs for student detail */
        .tabs-sd {
            display: flex;
            gap: 10px;
            margin: 10px 0 15px;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 10px;
            flex-wrap: wrap;
        }
        .tab-button-sd {
            padding: 10px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            color: var(--color-text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab-button-sd.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        .tab-content-sd { display: none; }
        .tab-content-sd.active { display: block; }

        .card {
            background: linear-gradient(#ffffff, #ffffff) padding-box,
                linear-gradient(135deg, rgba(33,141,141,0.35), rgba(52,152,219,0.25), rgba(39,174,96,0.20)) border-box;
            border: 1px solid transparent;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 12px 30px rgba(2, 6, 23, 0.08);
        }

        .card h3 { font-size: 18px; margin-bottom: 12px; color: var(--color-primary); }
        .card p { margin-bottom: 10px; color: var(--color-text-light); }

        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 768px) { .two-col { grid-template-columns: 1fr; } }

        .inline-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; align-items: center; }
        .muted { color: #888; font-size: 12px; }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: #f2f2f2;
            border: 1px solid var(--color-border);
        }

        .schedule-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            align-items: center;
            padding: 15px;
            background:
                radial-gradient(600px 140px at 15% 0%, rgba(33,141,141,0.10), transparent 55%),
                #fafafa;
            border-radius: var(--radius);
            margin-bottom: 12px;
            border: 1px solid rgba(0,0,0,0.06);
        }

        .schedule-info { display: flex; flex-direction: column; }
        .schedule-info strong { color: var(--color-primary); font-size: 16px; }
        .schedule-info small { color: var(--color-text-light); font-size: 12px; }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-platform { background: var(--color-info); color: white; }

        .assignment {
            background:
                radial-gradient(520px 140px at 10% 0%, rgba(52,152,219,0.10), transparent 55%),
                #f9f9f9;
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            border-left: 4px solid var(--color-primary);
        }

        .assignment h4 { margin: 0 0 8px 0; color: var(--color-primary); }

        .assignment-meta { display: flex; gap: 20px; margin-bottom: 12px; flex-wrap: wrap; }
        .assignment-meta small { color: var(--color-text-light); display: flex; gap: 5px; align-items: center; }

        .assignment-actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-small-primary { background: var(--color-primary); color: white; }
        .btn-small-primary:hover { background: var(--color-primary-hover); }

        .btn-small-secondary { background: #e0e0e0; color: var(--color-text); }
        .btn-small-secondary:hover { background: #d0d0d0; }

        .status-completed { color: var(--color-success); font-weight: 700; }
        .status-in_progress, .status-in-progress { color: var(--color-warning); font-weight: 700; }
        .status-not_started, .status-not-started { color: var(--color-danger); font-weight: 700; }

        .user-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: var(--radius);
            margin-bottom: 12px;
            border: 1px solid var(--color-border);
            gap: 12px;
        }

        .user-info-text { display: flex; flex-direction: column; gap: 4px; }
        .user-actions { display: flex; gap: 10px; flex-wrap: wrap; }

        .student-item {
            padding: 15px;
            background: #f9f9f9;
            border-radius: var(--radius);
            margin-bottom: 10px;
            border-left: 4px solid var(--color-primary);
            border: 1px solid rgba(0,0,0,0.06);
        }

        .student-item strong { color: var(--color-primary); display: block; }
        .student-item small { color: var(--color-text-light); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 24px 70px rgba(2, 6, 23, 0.22);
            border: 1px solid rgba(0,0,0,0.06);
        }

        .modal-header { font-size: 20px; font-weight: 800; margin-bottom: 20px; color: var(--color-primary); }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: var(--color-text-light); }

        .calendar { border: 1px solid var(--color-border); border-radius: var(--radius); padding: 15px; background: white; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-controls { display: flex; align-items: center; gap: 10px; width: 100%; justify-content: space-between; }
        .calendar-controls button { background: var(--color-primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .calendar-controls span { font-weight: 800; color: var(--color-primary); }

        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 5px; }
        .weekday { text-align: center; font-size: 12px; font-weight: 800; color: var(--color-text-light); padding: 5px; }

        .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }

        .day {
            text-align: center;
            padding: 8px 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            position: relative;
            background: white;
        }

        .day:hover { background: rgba(33, 141, 141, 0.1); }
        .day.other-month { color: #ccc; background: #f9f9f9; }
        .day.selected { background: var(--color-primary); color: white; font-weight: 900; }
        .day.has-schedule::after { content: ''; position: absolute; bottom: 2px; width: 4px; height: 4px; background: var(--color-primary); border-radius: 50%; left: 50%; transform: translateX(-50%); }
        .day.selected.has-schedule::after { background: white; }

        .schedule-day-header { font-size: 18px; font-weight: 900; margin-bottom: 15px; color: var(--color-primary); }

        .time-picker { display: flex; align-items: center; gap: 8px; }
        .time-sep { font-weight: 900; color: var(--color-text-light); user-select: none; }

        @media (max-width: 768px) {
            .schedule-item { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .user-info { width: 100%; flex-direction: column; align-items: flex-start; }
            .auth-form { padding: 30px 20px; }
            .user-card { flex-direction: column; align-items: flex-start; }
            .btn-primary:hover { transform: none; }
        }
    </style>
</head>
<body>

    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-form">
            <div id="loginForm">
                <div class="brand">
                    <div class="brand-mark" aria-hidden="true">üìò</div>
                    <div>
                        <div class="brand-title">StudyFlow</div>
                        <div class="brand-subtitle">–ü–æ—Ä—Ç–∞–ª –¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ —Ç–∞ —É—á–Ω—ñ–≤</div>
                    </div>
                </div>

                <h1>–í—Ö—ñ–¥</h1>
                <p>–î–æ—Å—Ç—É–ø –¥–æ –ü–æ—Ä—Ç–∞–ª–∞</p>

                <div id="loginError"></div>

                <!-- Supabase setup (–±–µ–∑ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–æ–¥—É) -->
                <div id="supabaseSetup" style="display:none; margin: 12px 0 2px; padding: 12px; border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; background: linear-gradient(135deg, rgba(33,141,141,0.08), rgba(52,152,219,0.06));">
                    <div style="font-weight: 800; color: #0f172a; margin-bottom: 6px;">‚öôÔ∏è –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Supabase</div>
                    <div class="muted" style="margin-bottom: 10px;">–í—Å—Ç–∞–≤ Project URL —Ç–∞ anon public key (Settings ‚Üí API). –ó–±–µ—Ä–µ–∂–µ–º–æ —É —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.</div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="sbUrl" style="font-size: 12px;">Supabase URL</label>
                        <input id="sbUrl" type="text" placeholder="https://xxxx.supabase.co" />
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="sbAnon" style="font-size: 12px;">Supabase anon public key</label>
                        <input id="sbAnon" type="text" placeholder="eyJhbGciOi..." />
                    </div>
                    <div class="inline-actions" style="margin-top: 6px;">
                        <button id="saveSupabaseBtn" class="btn-small btn-small-primary" type="button" style="padding: 8px 12px;">–ó–±–µ—Ä–µ–≥—Ç–∏ —ñ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
                        <button id="clearSupabaseBtn" class="btn-small btn-small-secondary" type="button" style="padding: 8px 12px;">–°–∫–∏–Ω—É—Ç–∏</button>
                        <span class="muted">(–¥–µ–º–æ-—Ä–µ–∂–∏–º –ø—Ä–∞—Ü—é—î –±–µ–∑ Supabase)</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" required />
                </div>
                <div class="form-group">
                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                </div>
                <button id="loginBtn" class="btn btn-primary" type="button">–£–≤—ñ–π—Ç–∏</button>
                <div class="toggle-link">
                    –ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç—É? <a id="toRegisterLink" href="#">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</a>
                    <div style="margin-top: 10px; font-size: 12px;">
                        <a id="forgotPwdLink" href="#" style="color: var(--color-primary);">–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
                    </div>
                </div>
            </div>

            <div id="registerForm" style="display: none;">
                <div class="brand">
                    <div class="brand-mark" aria-hidden="true">üß†</div>
                    <div>
                        <div class="brand-title">StudyFlow</div>
                        <div class="brand-subtitle">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∞–∫–∞—É–Ω—Ç–∞</div>
                    </div>
                </div>

                <h1>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h1>
                <p>–°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç</p>
                <div id="registerError"></div>
                <div id="registerSuccess"></div>

                <div class="form-group">
                    <label for="regName">–Ü–º'—è:</label>
                    <input type="text" id="regName" placeholder="–í–∞—à–µ —ñ–º'—è" required />
                </div>
                <div class="form-group">
                    <label for="regEmail">Email:</label>
                    <input type="email" id="regEmail" placeholder="your@example.com" required />
                </div>
                <div class="form-group">
                    <label for="regPassword">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="regPassword" placeholder="–ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤" required />
                </div>
                <div class="form-group">
                    <label for="regPasswordConfirm">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—é:</label>
                    <input type="password" id="regPasswordConfirm" placeholder="–ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –ø–∞—Ä–æ–ª—å" required />
                </div>

                <button id="registerBtn" class="btn btn-primary" type="button">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
                <div class="toggle-link">
                    –í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <a id="toLoginLink" href="#">–£–≤—ñ–π—Ç–∏</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard">
        <div class="header">
            <h2>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
            <div class="user-info">
                <div>
                    <span>–ü—Ä–∏–≤—ñ—Ç, <strong id="adminName"></strong>!</span>
                    <span class="role-badge admin">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                </div>
                <button class="btn-logout" onclick="logout()">–í–∏—Ö—ñ–¥</button>
            </div>
        </div>

        <div class="container">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('users', this)">üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</button>
                <button class="tab-button" onclick="switchTab('assignments', this)">üìù –ó–∞–≤–¥–∞–Ω–Ω—è</button>
            </div>

            <div id="users" class="tab-content active">
                <div class="card">
                    <h3>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</h3>
                    <div id="usersList"></div>
                </div>
            </div>

            <div id="assignments" class="tab-content">
                <div class="card">
                    <h3>–í—Å—ñ –∑–∞–≤–¥–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏</h3>
                    <div id="allAssignmentsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacherDashboard" class="dashboard">
        <div class="header">
            <h2>üë®‚Äçüè´ –ö–∞–±—ñ–Ω–µ—Ç –≤–∏–∫–ª–∞–¥–∞—á–∞</h2>
            <div class="user-info">
                <div>
                    <span>–ü—Ä–∏–≤—ñ—Ç, <strong id="teacherName"></strong>!</span>
                    <span class="role-badge teacher">–í–∏–∫–ª–∞–¥–∞—á</span>
                </div>
                <button class="btn-logout" onclick="logout()">–í–∏—Ö—ñ–¥</button>
            </div>
        </div>

        <div class="container">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('schedule', this)">üìÖ –†–æ–∑–∫–ª–∞–¥</button>
                <button class="tab-button" onclick="switchTab('students', this)">üë• –ú–æ—ó —É—á–Ω—ñ</button>
            </div>

            <div id="schedule" class="tab-content active">
                <div class="card">
                    <h3>–ö–µ—Ä—É–≤–∞–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥–æ–º –∑–∞–Ω—è—Ç—å</h3>
                    <button class="btn btn-primary" style="margin-bottom: 20px;" type="button" onclick="openAddScheduleModal()">+ –î–æ–¥–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è</button>
                    <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
                        <div id="calendarContainer"></div>
                        <div id="scheduleList"></div>
                    </div>
                </div>
            </div>

            <div id="students" class="tab-content">
                <div class="card">
                    <div style="display:flex; align-items:center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                        <h3 style="margin-bottom: 0;">–ú–æ—ó —É—á–Ω—ñ</h3>
                        <div id="teacherStudentsTopActions"></div>
                    </div>
                    <div style="height: 12px;"></div>
                    <div id="teacherStudentsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Dashboard -->
    <div id="studentDashboard" class="dashboard">
        <div class="header">
            <h2>üìö –ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</h2>
            <div class="user-info">
                <div>
                    <span>–ü—Ä–∏–≤—ñ—Ç, <strong id="studentName"></strong>!</span>
                    <span class="role-badge student">–£—á–µ–Ω—å</span>
                </div>
                <button class="btn-logout" onclick="logout()">–í–∏—Ö—ñ–¥</button>
            </div>
        </div>

        <div class="container">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('mySchedule', this)">üìÖ –†–æ–∑–∫–ª–∞–¥</button>
                <button class="tab-button" onclick="switchTab('myAssignments', this)">üìù –ó–∞–≤–¥–∞–Ω–Ω—è</button>
                <button class="tab-button" onclick="switchTab('myMaterials', this)">üìö –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏</button>
            </div>

            <div id="mySchedule" class="tab-content active">
                <div class="card">
                    <h3>–†–æ–∑–∫–ª–∞–¥ –∑–∞–Ω—è—Ç—å</h3>
                    <div id="myScheduleList"></div>
                </div>
            </div>

            <div id="myAssignments" class="tab-content">
                <div class="card">
                    <h3>–î–æ–º–∞—à–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>
                    <div id="myAssignmentsList"></div>
                </div>
            </div>

            <div id="myMaterials" class="tab-content">
                <div class="card">
                    <h3>–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –≤—ñ–¥ –≤–∏–∫–ª–∞–¥–∞—á–∞</h3>
                    <div id="myMaterialsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('editUserModal')">&times;</span>
            <div class="modal-header">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</div>
            <form onsubmit="saveUserChanges(event)">
                <div class="form-group">
                    <label>–Ü–º'—è: <strong id="editUserName"></strong></label>
                </div>
                <div class="form-group">
                    <label>Email: <strong id="editUserEmail"></strong></label>
                </div>
                <div class="form-group">
                    <label for="editUserRole">–†–æ–ª—å:</label>
                    <select id="editUserRole" required>
                        <option value="student">–£—á–µ–Ω—å</option>
                        <option value="teacher">–í–∏–∫–ª–∞–¥–∞—á</option>
                    </select>
                </div>
                <div id="teacherAssignmentDiv" style="display: none;">
                    <div class="form-group">
                        <div class="pill" style="margin-bottom: 10px;">üîê –ü—Ä–∞–≤–∞ –≤–∏–∫–ª–∞–¥–∞—á–∞</div>
                        <div style="padding: 10px; border: 1px solid var(--color-border); border-radius: var(--radius); background: #fafafa; margin-bottom: 10px;">
                            <label style="display:flex; gap: 10px; align-items: flex-start; font-weight: 700; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="teacherCanAddStudents" style="margin-top: 3px;" />
                                <span>–î–æ–∑–≤–æ–ª–∏—Ç–∏ –≤–∏–∫–ª–∞–¥–∞—á—É —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ –¥–æ–¥–∞–≤–∞—Ç–∏ —Å–æ–±—ñ —É—á–Ω—ñ–≤ (–ø—Ä–∞–≤–æ –≤—ñ–¥ –∞–¥–º—ñ–Ω–∞)</span>
                            </label>
                            <div class="muted" style="margin-top: 6px;">–Ø–∫—â–æ –≤–∏–º–∫–Ω–µ–Ω–æ ‚Äî –≤–∏–∫–ª–∞–¥–∞—á –±–∞—á–∏—Ç—å –ª–∏—à–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏—Ö –∞–¥–º—ñ–Ω–æ–º / —á–µ—Ä–µ–∑ —Ä–æ–∑–∫–ª–∞–¥.</div>
                        </div>
                        <label for="assignTeacher">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –≤–∏–∫–ª–∞–¥–∞—á—É —É—á–Ω—ñ–≤:</label>
                        <div id="assignStudentsList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius); padding: 10px;"></div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="passwordResetModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('passwordResetModal')">&times;</span>
            <div class="modal-header">–°–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—é</div>

            <!-- Step 1: request reset email -->
            <form id="resetRequestForm" onsubmit="sendPasswordResetEmail(event)">
                <div id="resetError"></div>
                <div id="resetSuccess"></div>
                <div class="form-group">
                    <label for="resetEmail">–í–≤–µ–¥—ñ—Ç—å –≤–∞—à email:</label>
                    <input type="email" id="resetEmail" required />
                </div>
                <button type="submit" class="btn btn-primary">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ª–∏—Å—Ç –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è</button>
                <div class="muted" style="margin-top: 10px;">–ú–∏ –Ω–∞–¥—ñ—à–ª–µ–º–æ –≤–∞–º –ª–∏—Å—Ç —ñ–∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º –¥–ª—è –∑–º—ñ–Ω–∏ –ø–∞—Ä–æ–ª—é.</div>
            </form>

            <!-- Step 2: set new password -->
            <form id="resetNewPasswordForm" style="display:none;" onsubmit="updatePasswordFromRecovery(event)">
                <div id="resetNewPwdError"></div>
                <div id="resetNewPwdSuccess"></div>
                <div class="form-group">
                    <label for="newPassword">–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="newPassword" placeholder="–ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤" required />
                </div>
                <div class="form-group">
                    <label for="newPassword2">–ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="newPassword2" placeholder="–ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –ø–∞—Ä–æ–ª—å" required />
                </div>
                <button type="submit" class="btn btn-primary">–ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å</button>
                <div class="muted" style="margin-top: 10px;">–ü—ñ—Å–ª—è –∑–º—ñ–Ω–∏ –ø–∞—Ä–æ–ª—é –≤–∏ –∑–º–æ–∂–µ—Ç–µ —É–≤—ñ–π—Ç–∏ –∑ –Ω–æ–≤–∏–º–∏ –¥–∞–Ω–∏–º–∏.</div>
            </form>
        </div>
    </div>

    <!-- Add Schedule Modal -->
    <div id="addScheduleModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addScheduleModal')">&times;</span>
            <div class="modal-header">–î–æ–¥–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è</div>
            <form onsubmit="saveSchedule(event)">
                <div class="form-group">
                    <label for="schedName">–ù–∞–∑–≤–∞ –ø—Ä–µ–¥–º–µ—Ç—É:</label>
                    <input type="text" id="schedName" required />
                </div>
                <div class="form-group">
                    <label for="schedDate">–î–∞—Ç–∞:</label>
                    <input type="date" id="schedDate" required />
                </div>
                <div class="form-group">
                    <label>–ß–∞—Å (24-–≥–æ–¥–∏–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç):</label>
                    <div class="time-picker" aria-label="–í–∏–±—ñ—Ä —á–∞—Å—É">
                        <select id="schedHour" required aria-label="–ì–æ–¥–∏–Ω–∞">
                            <option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option>
                            <option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option>
                            <option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option>
                            <option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option>
                        </select>
                        <span class="time-sep">:</span>
                        <select id="schedMinute" required aria-label="–•–≤–∏–ª–∏–Ω–∏">
                            <option value="00">00</option><option value="05">05</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option>
                            <option value="30">30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option>
                        </select>
                        <span class="muted" style="margin-left: 10px;">–∫—Ä–æ–∫ 5 —Ö–≤</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="schedPlatform">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</label>
                    <select id="schedPlatform" required>
                        <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—É</option>
                        <option value="Zoom">Zoom</option>
                        <option value="Google Meet">Google Meet</option>
                        <option value="Microsoft Teams">Microsoft Teams</option>
                        <option value="–û—á–Ω–µ">–û—á–Ω–µ –∑–∞–Ω—è—Ç—Ç—è</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="schedLink">–ü–æ—Å–∏–ª–∞–Ω–Ω—è (–æ–ø—Ü—ñ–π–Ω–æ):</label>
                    <input type="url" id="schedLink" placeholder="https://..." />
                </div>
                <div class="form-group">
                    <label>–£—á–Ω—ñ:</label>
                    <div id="schedStudentsCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius); padding: 10px;"></div>
                </div>
                <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- Assignment Detail Modal -->
    <div id="assignmentDetailModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('assignmentDetailModal')">&times;</span>
            <div class="modal-header" id="assignDetailTitle"></div>
            <div id="assignDetailContent"></div>
        </div>
    </div>

    <!-- Submit Assignment Modal -->
    <div id="submitAssignmentModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('submitAssignmentModal')">&times;</span>
            <div class="modal-header">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è</div>
            <form onsubmit="submitAssignmentSolution(event)">
                <div class="form-group">
                    <label for="solutionText">–¢–µ–∫—Å—Ç–æ–≤–µ —Ä—ñ—à–µ–Ω–Ω—è (–æ–ø—Ü—ñ–π–Ω–æ):</label>
                    <textarea id="solutionText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤–æ—î —Ä—ñ—à–µ–Ω–Ω—è —Ç—É—Ç."></textarea>
                </div>
                <div class="form-group">
                    <label for="solutionFiles">–§–∞–π–ª–∏ (—Ç–µ–∫—Å—Ç, –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è, –¥–æ–∫—É–º–µ–Ω—Ç–∏):</label>
                    <input type="file" id="solutionFiles" multiple accept=".txt,doc,docx,pdf,jpg,jpeg,png,gif,zip" />
                    <small style="color: #999; display: block; margin-top: 5px;">–ú–æ–∂–Ω–∞ –≤–∏–±—Ä–∞—Ç–∏ –¥–µ–∫—ñ–ª—å–∫–∞ —Ñ–∞–π–ª—ñ–≤</small>
                    <div id="uploadedFilesList" style="margin-top: 10px;"></div>
                </div>
                <button type="submit" class="btn btn-primary">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- Teacher: Student Detail Modal -->
    <div id="studentDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close" onclick="closeModal('studentDetailModal')">&times;</span>
            <div class="modal-header" id="studentDetailTitle">–ö–∞—Ä—Ç–∫–∞ —É—á–Ω—è</div>

            <div class="tabs-sd">
                <button class="tab-button-sd active" onclick="switchStudentDetailTab('sd_lessons', this)">üìÖ –ó–∞–Ω—è—Ç—Ç—è</button>
                <button class="tab-button-sd" onclick="switchStudentDetailTab('sd_homework', this)">üìù –î–æ–º–∞—à–Ω—ñ</button>
                <button class="tab-button-sd" onclick="switchStudentDetailTab('sd_materials', this)">üìö –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏</button>
            </div>

            <div id="sd_lessons" class="tab-content-sd active"></div>
            <div id="sd_homework" class="tab-content-sd"></div>
            <div id="sd_materials" class="tab-content-sd"></div>
        </div>
    </div>

    <!-- Teacher: Add Students Modal -->
    <div id="addStudentToTeacherModal" class="modal">
        <div class="modal-content" style="max-width: 560px;">
            <span class="modal-close" onclick="closeModal('addStudentToTeacherModal')">&times;</span>
            <div class="modal-header">‚ûï –î–æ–¥–∞—Ç–∏ —É—á–Ω—ñ–≤</div>
            <form onsubmit="saveAddedStudentsToTeacher(event)">
                <div id="addTeacherStudentsHint" class="muted" style="margin-bottom: 10px;"></div>
                <div id="addTeacherStudentsCheckboxes" style="max-height: 320px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius); padding: 10px;"></div>
                <div class="inline-actions" style="margin-top: 12px;">
                    <button class="btn-small btn-small-primary" type="submit">–î–æ–¥–∞—Ç–∏ –≤–∏–±—Ä–∞–Ω–∏—Ö</button>
                    <button class="btn-small btn-small-secondary" type="button" onclick="closeModal('addStudentToTeacherModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase CDN (guarded) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous" referrerpolicy="no-referrer" onerror="window.__supabaseLoadError=true;"></script>

    <script>
        // ========================
        //  CONFIG
        // ========================
        const SUPABASE_URL = 'https://dmphjqstprqgvoanargh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtcGhqcXN0cHJxZ3ZvYW5hcmdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODMxNTYsImV4cCI6MjA4MzM1OTE1Nn0.UVVpm4LezWQNT28wXX2pzxWVQSPCVm8OX2NslqM6Nns';

        // ‚úÖ –í–∫–∞–∂–∏ email –≤–ª–∞—Å–Ω–∏–∫–∞ —Å–∞–π—Ç—É (—Ç–∏). –¶–µ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±—É–¥–µ –º–∞—Ç–∏ —Ä–æ–ª—å admin.
        // –ü–æ—Ä–∞–¥–∞: –∑—Ä–æ–±–∏ exact match –¥–æ —Ä–µ–≥—ñ—Å—Ç—Ä—É –Ω–µ –ø—Ä–∏–≤'—è–∑—É–π—Å—è ‚Äî –º–∏ –ø–æ—Ä—ñ–≤–Ω—é—î–º–æ lowercased.
        const OWNER_EMAIL = 'daria.voronova@ukr.net'; // <-- –∑–∞–º—ñ–Ω–∏ –Ω–∞ —Å–≤—ñ–π email (–∞–±–æ –∑–∞–ª–∏—à, —è–∫—â–æ —Ü–µ —Ç–∏)

        // ========================
        //  SUPABASE INIT (SAFE)
        // ========================
        let sb = null;
        // For recovery links we want better diagnostics
        let __recoveryLastError = null;
        function getSupabaseConfig() {
            // Prefer localStorage values (set via UI), fallback to constants.
            let url = '';
            let key = '';
            try {
                url = (localStorage.getItem('sb_url') || '').trim();
                key = (localStorage.getItem('sb_anon') || '').trim();
            } catch (_) {}

            if (!url) url = String(SUPABASE_URL || '').trim();
            if (!key) key = String(SUPABASE_ANON_KEY || '').trim();

            return { url, key };
        }

        function isSupabaseConfigured() {
            const { url, key } = getSupabaseConfig();
            return typeof url === 'string'
                && typeof key === 'string'
                && url.startsWith('http')
                && key.startsWith('ey');
        }
        function isSupabaseLoaded() {
            return !!(window.supabase && typeof window.supabase.createClient === 'function');
        }
        function getSupabaseClient() {
            if (sb) return sb;
            if (!isSupabaseConfigured() || !isSupabaseLoaded()) return null;
            try {
                const cfg = getSupabaseConfig();
                sb = window.supabase.createClient(cfg.url, cfg.key, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: true
                    }
                });
                return sb;
            } catch (e) {
                console.warn('Supabase init failed:', e);
                sb = null;
                return null;
            }
        }

        // ========================
        //  DEMO DATA (fallback)
        // ========================
        const appData = {
            schedule: [
                {
                    id: 'sched_1',
                    name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',
                    date: '2026-01-07',
                    time: '15:00',
                    platform: 'Zoom',
                    link: 'https://zoom.us/j/123456789',
                    teacherId: 'teacher_001',
                    studentIds: ['student_1', 'student_2']
                },
                {
                    id: 'sched_2',
                    name: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞ –º–æ–≤–∞',
                    date: '2026-01-09',
                    time: '16:00',
                    platform: 'Google Meet',
                    link: 'https://meet.google.com/abc',
                    teacherId: 'teacher_001',
                    studentIds: ['student_1']
                }
            ],
            assignments: [
                {
                    id: 'assign_1',
                    title: '–†—ñ–≤–Ω—è–Ω–Ω—è –¥—Ä—É–≥–æ–≥–æ —Å—Ç–µ–ø–µ–Ω—è ‚Äî –ø—Ä–∞–∫—Ç–∏–∫–∞',
                    description: '–†–æ–∑–≤\'—è–∑–∞—Ç–∏ 10 —Ä—ñ–≤–Ω—è–Ω—å (‚Ññ1‚Äì10). –£ ‚Ññ5 –ø–µ—Ä–µ–≤—ñ—Ä –¥–∏—Å–∫—Ä–∏–º—ñ–Ω–∞–Ω—Ç —ñ –∫–æ—Ä–µ–Ω—ñ.',
                    deadline: '2026-01-08',
                    teacherId: 'teacher_001',
                    studentIds: ['student_1', 'student_2'],
                    linkedLessonId: 'sched_1',
                    teacherFiles: ['worksheet_qe.pdf', 'hint_formulas.png'],
                    studentStatus: { 'student_1': 'completed', 'student_2': 'in_progress' },
                    studentComments: {
                        'student_1': '–î–æ–±—Ä–µ! –ê–ª–µ –ø–µ—Ä–µ–≤—ñ—Ä –∑–∞–≤–¥–∞–Ω–Ω—è ‚Ññ5 ‚Äî —Ç–∞–º –ø–æ–º–∏–ª–∫–∞ –≤ –æ–±—á–∏—Å–ª–µ–Ω–Ω—ñ D.',
                        'student_2': '–°–ø—Ä–æ–±—É–π —Ä–æ–±–∏—Ç–∏ –∞–∫—É—Ä–∞—Ç–Ω—ñ—à–µ –ø—Ä–æ–º—ñ–∂–Ω—ñ –∫—Ä–æ–∫–∏ (–æ—Å–æ–±–ª–∏–≤–æ –≤ ‚Ññ3 —ñ ‚Ññ7).'
                    },
                    studentSubmissions: {
                        'student_1': {
                            text: "–Ø —Ä–æ–∑–≤'—è–∑–∞–ª–∞ –≤—Å—ñ 10.\n‚Ññ5: —Å–ø–æ—á–∞—Ç–∫—É –∑—Ä–æ–±–∏–ª–∞ D=25, –ø–æ—Ç—ñ–º –ø–µ—Ä–µ–≤—ñ—Ä–∏–ª–∞ —â–µ —Ä–∞–∑ ‚Äî –∑–¥–∞—î—Ç—å—Å—è, –æ–∫.\n–ü—ñ–¥–∫–∞–∂—ñ—Ç—å, –¥–µ —Å–∞–º–µ –ø–æ–º–∏–ª–∫–∞?",
                            files: ['solution_maria.pdf', 'photo_notebook.jpg'],
                            date: '06.01.2026'
                        }
                    }
                },
                {
                    id: 'assign_2',
                    title: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞: Daily Routine ‚Äî speaking + writing',
                    description: '1) –ó–∞–ø–∏—Å–∞—Ç–∏ –∫–æ—Ä–æ—Ç–∫–µ –∞—É–¥—ñ–æ (30‚Äì45 —Å–µ–∫) –ø—Ä–æ —Å–≤—ñ–π –¥–µ–Ω—å.\n2) –ù–∞–ø–∏—Å–∞—Ç–∏ 5 —Ä–µ—á–µ–Ω—å –∑ –Ω–æ–≤–∏–º–∏ —Å–ª–æ–≤–∞–º–∏.',
                    deadline: '2026-01-10',
                    teacherId: 'teacher_001',
                    studentIds: ['student_1'],
                    linkedLessonId: 'sched_2',
                    teacherFiles: ['daily_routine_prompt.pdf', 'useful_phrases.docx'],
                    studentStatus: { 'student_1': 'not_started' },
                    studentComments: { 'student_1': '' },
                    studentSubmissions: {}
                }
            ],
            users: {
                'admin_001': { id: 'admin_001', name: '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä', email: 'admin@example.com', password: 'demo123', role: 'admin' },
                'teacher_001': { id: 'teacher_001', name: '–Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ', email: 'teacher@example.com', password: 'demo123', role: 'teacher', students: ['student_1', 'student_2'], canAddStudents: true },
                'student_1': { id: 'student_1', name: '–ú–∞—Ä—ñ—è –Ü–≤–∞–Ω–æ–≤–∞', email: 'maria@example.com', password: 'demo123', role: 'student' },
                'student_2': { id: 'student_2', name: '–ü–µ—Ç—Ä–æ –°–∏–¥–æ—Ä–µ–Ω–∫–æ', email: 'petro@example.com', password: 'demo123', role: 'student' }
            },
            personalNotes: {
                'student_1': '–ú–∞—Ä—ñ—è –ø–æ–∫–∞–∑—É—î —á—É–¥–æ–≤—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —É –º–∞—Ç–µ–º–∞—Ç–∏—Ü—ñ. –ü—Ä–æ–¥–æ–≤–∂—É–π –≤ —Ç–æ–º—É –∂ –¥—É—Å—ñ!',
                'student_2': '–ü–µ—Ç—Ä–æ, –ø—Ä–∞—Ü—é–π –Ω–∞–¥ –¥–∏–∫—Ü—ñ—î—é. –¢–≤—ñ–π –ø—Ä–æ–≥—Ä–µ—Å –ø–æ–º—ñ—Ç–Ω–∏–π.'
            },
            studentMaterials: {
                'student_1': [
                    {
                        id: 'mat_demo_1',
                        title: '–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏: Quadratic Equations (–∫–æ–Ω—Å–ø–µ–∫—Ç + –ø—Ä–∏–∫–ª–∞–¥–∏)',
                        date: '2026-01-07',
                        description: '–ü—ñ—Å–ª—è —É—Ä–æ–∫—É: –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–Ω—Å–ø–µ–∫—Ç, 5 —Ç–∏–ø–æ–≤–∏—Ö –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ —ñ —Ç–∞–±–ª–∏—Ü—è —Ñ–æ—Ä–º—É–ª.\n\n‚úÖ –ü–æ—Ä–∞–¥–∞: —Å–ø–æ—á–∞—Ç–∫—É –ø–æ–¥–∏–≤–∏—Å—å 2 –ø—Ä–∏–∫–ª–∞–¥–∏, –ø–æ—Ç—ñ–º –∑—Ä–æ–±–∏ –≤–ø—Ä–∞–≤–∏ —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ.',
                        scheduleId: 'sched_1',
                        files: ['quadratic-notes.pdf', 'formula-sheet.png', 'practice-worksheet.docx']
                    },
                    {
                        id: 'mat_demo_2',
                        title: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞: Vocabulary ‚Äî Daily Routine',
                        date: '2026-01-09',
                        description: '–°–ª–æ–≤–∞ + –ø—Ä–∏–∫–ª–∞–¥–∏ —Ä–µ—á–µ–Ω—å.\n\n–î–æ–º–æ–≤–∏–ª–∏—Å—å: 10 —Å–ª—ñ–≤ –≤ –∞–∫—Ç–∏–≤, –∑—Ä–æ–±–∏—Ç–∏ 5 —Ä–µ—á–µ–Ω—å –ø—Ä–æ —Å–≤—ñ–π –¥–µ–Ω—å.',
                        scheduleId: 'sched_2',
                        files: ['daily-routine-vocab.xlsx', 'listening-track.mp3']
                    }
                ],
                'student_2': [
                    {
                        id: 'mat_demo_3',
                        title: '–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏: –ü–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è ‚Äî –¥–∏—Å–∫—Ä–∏–º—ñ–Ω–∞–Ω—Ç',
                        date: '2026-01-07',
                        description: '–ö–æ—Ä–æ—Ç–∫–∞ –ø–∞–º‚Äô—è—Ç–∫–∞ –ø–æ –¥–∏—Å–∫—Ä–∏–º—ñ–Ω–∞–Ω—Ç—É + 3 —Ä–æ–∑–≤‚Äô—è–∑–∞–Ω—ñ –ø—Ä–∏–∫–ª–∞–¥–∏.\n\n–Ø–∫—â–æ —î –ø–∏—Ç–∞–Ω–Ω—è ‚Äî –Ω–∞–ø–∏—à–∏ –º–µ–Ω—ñ –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–∏–º —É—Ä–æ–∫–æ–º.',
                        scheduleId: 'sched_1',
                        files: ['discriminant-cheatsheet.pdf', 'examples-3.pdf']
                    }
                ]
            }
        };

        let currentUser = null;
        let editingScheduleId = null;
        let editingUserId = null;

        // ========================
        //  HELPERS
        // ========================
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        function findDemoUser(email, password) {
            const users = Object.values(appData.users);
            return users.find(u => u.email === email && u.password === password) || null;
        }

        function getAppUrl() {
            let url = location.origin + location.pathname;
            url = url.replace(/index\.html$/i, '');
            url = url.endsWith('/') ? url : (url + '/');
            return url;
        }

        function isOwnerEmail(email) {
            if (!OWNER_EMAIL) return false;
            return String(email || '').trim().toLowerCase() === String(OWNER_EMAIL).trim().toLowerCase();
        }

        function getEffectiveRole(authEmail, profileRole) {
            // –í–ª–∞—Å–Ω–∏–∫ —Å–∞–π—Ç—É –∑–∞–≤–∂–¥–∏ admin (–¥–ª—è UI), –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤ profiles —â–µ –Ω–µ –æ–Ω–æ–≤–∏–ª–æ—Å—å.
            return isOwnerEmail(authEmail) ? 'admin' : (profileRole || 'student');
        }

        function isRecoveryFromUrl() {
            const qs = new URLSearchParams(location.search);
            // Supabase –º–æ–∂–µ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ –∞–±–æ ?mode=recovery (–Ω–∞—à redirect), –∞–±–æ ?type=recovery, –∞–±–æ ?code=... (PKCE)
            if (qs.get('mode') === 'recovery') return true;
            if (qs.get('type') === 'recovery') return true;
            if (qs.has('code')) return true;
            const hash = String(location.hash || '');
            return /type=recovery/i.test(hash);
        }

        // Ensures we have an auth session in PASSWORD_RECOVERY flow.
        // With PKCE links, Supabase returns ?code=... and we MUST exchange it for a session.
        async function ensureRecoverySession(client) {
            if (!client) return null;
            __recoveryLastError = null;

            // 1) Try existing session (covers hash-token flows)
            try {
                const { data } = await client.auth.getSession();
                if (data?.session) return data.session;
            } catch (e) {
                // ignore
            }

            // 2) PKCE: exchange ?code=... for a session
            try {
                const url = new URL(location.href);
                const code = url.searchParams.get('code');
                if (code) {
                    const { data, error } = await client.auth.exchangeCodeForSession(code);
                    if (error) {
                        __recoveryLastError = error.message || String(error);
                        console.warn('exchangeCodeForSession failed:', error);
                        return null;
                    }
                    return data?.session || null;
                }
            } catch (e) {
                __recoveryLastError = String(e);
                console.warn('ensureRecoverySession failed:', e);
            }

            // 3) As a last attempt, try to let supabase parse URL itself
            // (some environments populate session async)
            try {
                const { data } = await client.auth.getSession();
                if (data?.session) return data.session;
            } catch (_) {}

            return null;
        }

        function stripHashFromUrl() {
            // –ß–∏—Å—Ç–∏–º–æ URL –ü–Ü–°–õ–Ø —É—Å–ø—ñ—à–Ω–æ—ó –∑–º—ñ–Ω–∏ –ø–∞—Ä–æ–ª—é (—â–æ–± –Ω–µ –∑–ª–∞–º–∞—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Å—ñ—ó).
            try {
                const url = new URL(location.href);
                url.hash = '';
                url.searchParams.delete('mode');
                url.searchParams.delete('type');
                url.searchParams.delete('code');
                const qs = url.searchParams.toString();
                history.replaceState({}, document.title, url.pathname + (qs ? ('?' + qs) : ''));
            } catch (_) {}
        }

        function formatDateUA(dateStr) {
            if (!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            return `${d}.${m}.${y}`;
        }

        function parseDateTime(dateStr, timeStr) {
            const t = timeStr ? timeStr : '00:00';
            return new Date(`${dateStr}T${t}:00`);
        }

        // Time picker helpers
        function pad2(n) { return String(n).padStart(2, '0'); }
        function getRoundedTime5() {
            const d = new Date();
            const h = d.getHours();
            const m = d.getMinutes();
            const rounded = Math.round(m / 5) * 5;
            const hh = (rounded === 60) ? (h + 1) % 24 : h;
            const mm = (rounded === 60) ? 0 : rounded;
            return pad2(hh) + ':' + pad2(mm);
        }
        function setTimePickers(timeStr) {
            const hourEl = document.getElementById('schedHour');
            const minEl = document.getElementById('schedMinute');
            if (!hourEl || !minEl) return;

            const safe = (timeStr && timeStr.length === 5 && timeStr[2] === ':') ? timeStr : '12:00';
            const hh = safe.slice(0, 2);
            const mm = safe.slice(3, 5);

            hourEl.value = hh;

            const mInt = Math.max(0, Math.min(59, parseInt(mm, 10) || 0));
            const snapped = Math.round(mInt / 5) * 5;
            minEl.value = pad2(Math.min(55, snapped));
        }
        function getTimeFromPickers() {
            const hourEl = document.getElementById('schedHour');
            const minEl = document.getElementById('schedMinute');
            const hh = hourEl && hourEl.value ? hourEl.value : '12';
            const mm = minEl && minEl.value ? minEl.value : '00';
            return hh + ':' + mm;
        }

        // ========================
        //  MODALS
        // ========================
        function closeModal(modalId) {
            const el = document.getElementById(modalId);
            if (el) el.classList.remove('active');
        }

        // IMPORTANT: this function MUST exist globally, because it is called from onclick and auth bootstrap.
        function openPasswordResetModal(isRecovery = false) {
            const modal = document.getElementById('passwordResetModal');
            if (!modal) return;

            // reset messages
            document.getElementById('resetError').innerHTML = '';
            document.getElementById('resetSuccess').innerHTML = '';
            document.getElementById('resetNewPwdError').innerHTML = '';
            document.getElementById('resetNewPwdSuccess').innerHTML = '';

            const reqForm = document.getElementById('resetRequestForm');
            const newPwdForm = document.getElementById('resetNewPasswordForm');

            if (isRecovery) {
                reqForm.style.display = 'none';
                newPwdForm.style.display = 'block';
                document.getElementById('newPassword').value = '';
                document.getElementById('newPassword2').value = '';
            } else {
                reqForm.style.display = 'block';
                newPwdForm.style.display = 'none';
                document.getElementById('resetEmail').value = '';
            }

            modal.classList.add('active');
        }

        // ========================
        //  SUPABASE PROFILES
        // ========================
        async function getMyProfile(authUserId) {
            const client = getSupabaseClient();
            if (!client) return null;
            const { data, error } = await client
                .from('profiles')
                .select('user_id, full_name, role, legacy_id, can_add_students')
                .eq('user_id', authUserId)
                .maybeSingle();
            if (error) throw error;
            return data;
        }

        async function upsertMyProfile(profile, authUserId) {
            const client = getSupabaseClient();
            if (!client) return;
            const payload = {
                user_id: authUserId,
                full_name: profile.full_name || null,
                role: profile.role || 'student',
                legacy_id: profile.legacy_id || null,
                can_add_students: !!profile.can_add_students
            };
            const { error } = await client.from('profiles').upsert(payload, { onConflict: 'user_id' });
            if (error) throw error;
        }

        async function setCurrentUserFromSession(session) {
            const authUser = session?.user;
            if (!authUser) return;

            let profile = await getMyProfile(authUser.id);

            // 1) –Ø–∫—â–æ –ø—Ä–æ—Ñ—ñ–ª—é –Ω–µ–º–∞—î ‚Äî —Å—Ç–≤–æ—Ä—é—î–º–æ (owner -> admin)
            if (!profile) {
                const initialRole = getEffectiveRole(authUser.email, 'student');
                await upsertMyProfile({
                    full_name: authUser.user_metadata?.full_name || authUser.email,
                    role: initialRole,
                    legacy_id: null,
                    can_add_students: false
                }, authUser.id);

                profile = await getMyProfile(authUser.id);
            } else {
                // 2) –Ø–∫—â–æ –ø—Ä–æ—Ñ—ñ–ª—å —î, –∞–ª–µ —Ü–µ –≤–ª–∞—Å–Ω–∏–∫ —ñ —Ä–æ–ª—å –Ω–µ admin ‚Äî –ø—Ä–æ–±—É—î–º–æ –ø—ñ–¥–Ω—è—Ç–∏ —Ä–æ–ª—å —É profiles
                if (isOwnerEmail(authUser.email) && profile.role !== 'admin') {
                    try {
                        await upsertMyProfile({
                            full_name: profile.full_name || authUser.user_metadata?.full_name || authUser.email,
                            role: 'admin',
                            legacy_id: profile.legacy_id || null,
                            can_add_students: !!profile.can_add_students
                        }, authUser.id);
                        profile = await getMyProfile(authUser.id);
                    } catch (e) {
                        console.warn('Could not promote owner to admin in profiles (RLS?):', e);
                        // –í–∞–∂–ª–∏–≤–æ: –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –ë–î –Ω–µ –¥–∞–ª–∞ –æ–Ω–æ–≤–∏—Ç–∏ —Ä–æ–ª—å ‚Äî –¥–ª—è UI –≤–ª–∞—Å–Ω–∏–∫ –≤—Å–µ –æ–¥–Ω–æ admin.
                    }
                }
            }

            const legacyId = profile?.legacy_id || authUser.id;
            const effectiveRole = getEffectiveRole(authUser.email, profile?.role);

            if (!appData.users[legacyId]) {
                appData.users[legacyId] = {
                    id: legacyId,
                    name: profile?.full_name || authUser.email,
                    email: authUser.email,
                    password: '',
                    role: effectiveRole
                };
            }

            appData.users[legacyId].name = profile?.full_name || appData.users[legacyId].name || authUser.email;
            appData.users[legacyId].email = authUser.email;
            appData.users[legacyId].role = effectiveRole;

            if (effectiveRole === 'teacher') {
                if (!appData.users[legacyId].students) appData.users[legacyId].students = [];
                appData.users[legacyId].canAddStudents = !!profile?.can_add_students;
            } else {
                delete appData.users[legacyId].students;
                delete appData.users[legacyId].canAddStudents;
            }

            currentUser = appData.users[legacyId];
            currentUser.authUserId = authUser.id;

            // Debug log to confirm owner detection
            console.log('[Auth]', {
                email: authUser.email,
                OWNER_EMAIL,
                isOwner: isOwnerEmail(authUser.email),
                profileRole: profile?.role,
                effectiveRole
            });
        }

        // ========================
        //  AUTH
        // ========================
        async function bootstrapAuth() {
            const client = getSupabaseClient();

            if (!client) {
                // Demo mode, but we still want UI to work.
                if (window.__supabaseLoadError) {
                    const err = document.getElementById('loginError');
                    if (err) err.innerHTML = '<div class="error-message">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Supabase –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É (CDN). –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –∞–±–æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ñ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è. –ü—Ä–∞—Ü—é—î–º–æ —É –¥–µ–º–æ-—Ä–µ–∂–∏–º—ñ.</div>';
                } else if (!isSupabaseConfigured()) {
                    const err = document.getElementById('loginError');
                    if (err) err.innerHTML = '<div class="error-message">Supabase –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ (SUPABASE_URL / SUPABASE_ANON_KEY). –ü–æ–∫–∏ —â–æ –¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–µ–º–æ-—Ä–µ–∂–∏–º.</div>';
                }
                return;
            }

            // 1) subscribe first (important for PASSWORD_RECOVERY)
            client.auth.onAuthStateChange(async (event, session) => {
                if (event === 'PASSWORD_RECOVERY') {
                    // show auth screen + open new password form
                    document.getElementById('authScreen').style.display = 'flex';
                    document.getElementById('adminDashboard').classList.remove('active');
                    document.getElementById('teacherDashboard').classList.remove('active');
                    document.getElementById('studentDashboard').classList.remove('active');

                    // IMPORTANT: do NOT strip URL here ‚Äî we may need code/hash to create a session.
                    openPasswordResetModal(true);
                    return;
                }

                if (session?.user) {
                    await setCurrentUserFromSession(session);
                    if (!isRecoveryFromUrl()) showDashboard();
                }
            });

            // 2) if arrived via recovery link, force showing reset modal
            if (isRecoveryFromUrl()) {
                // Ensure recovery session exists (PKCE links require exchangeCodeForSession)
                const sess = await ensureRecoverySession(client);

                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('adminDashboard').classList.remove('active');
                document.getElementById('teacherDashboard').classList.remove('active');
                document.getElementById('studentDashboard').classList.remove('active');
                openPasswordResetModal(true);

                // If session couldn't be established, show a helpful message immediately
                if (!sess) {
                    const box = document.getElementById('resetNewPwdError');
                    const details = __recoveryLastError ? `<div class="muted" style="margin-top:6px;">–î–µ—Ç–∞–ª—ñ: ${escapeHtml(__recoveryLastError)}</div>` : '';
                    if (box) {
                        box.innerHTML = `<div class="error-message">–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ —Å–µ—Å—ñ—é –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è. –ù–∞–π—á–∞—Å—Ç—ñ—à–µ —Ü–µ —Å—Ç–∞—î—Ç—å—Å—è, —è–∫—â–æ:
                        <br>‚Ä¢ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤—ñ–¥–∫—Ä–∏—Ç–æ –≤ —ñ–Ω—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ/–≤–±—É–¥–æ–≤–∞–Ω–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ (Gmail/Instagram/Telegram)
                        <br>‚Ä¢ –∞–±–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–ª–∏ / –≤–æ–Ω–æ –∑–∞—Å—Ç–∞—Ä—ñ–ª–æ.
                        <br><br>‚úÖ –†—ñ—à–µ–Ω–Ω—è: –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?¬ª –Ω–∞ —Å–∞–π—Ç—ñ —â–µ —Ä–∞–∑ —ñ –≤—ñ–¥–∫—Ä–∏–π—Ç–µ –Ω–æ–≤–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —É —Ç–æ–º—É –∂ –±—Ä–∞—É–∑–µ—Ä—ñ, –¥–µ –≤–∏ —Ü–µ –∑—Ä–æ–±–∏–ª–∏ (–∞–±–æ —Å–∫–æ–ø—ñ—é–π—Ç–µ –ª—ñ–Ω–∫ —ñ –≤—Å—Ç–∞–≤—Ç–µ –≤ Chrome/Safari –≤—Ä—É—á–Ω—É).${details}</div>`;
                    }
                }

                // NOTE: URL will be cleaned after successful password update.
                return;
            }

            // 3) normal auto-login
            const { data } = await client.auth.getSession();
            if (data?.session) {
                await setCurrentUserFromSession(data.session);
                showDashboard();
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.innerHTML = '';

            const btn = document.getElementById('loginBtn');
            const oldBtnText = btn ? btn.textContent : '';
            const setLoading = (on) => {
                if (!btn) return;
                btn.disabled = !!on;
                btn.style.opacity = on ? '0.85' : '';
                btn.textContent = on ? '–í—Ö—ñ–¥‚Ä¶' : oldBtnText;
            };

            if (!email || !password) {
                errorDiv.innerHTML = '<div class="error-message">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è</div>';
                return;
            }

            const client = getSupabaseClient();
            if (!client) {
                // demo login
                const demo = findDemoUser(email, password);
                if (!demo) {
                    errorDiv.innerHTML = '<div class="error-message">–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å (–¥–µ–º–æ-—Ä–µ–∂–∏–º).</div>';
                    return;
                }
                currentUser = { ...demo };
                try {
                    showDashboard();
                } catch (e) {
                    console.error('showDashboard failed (demo):', e);
                    errorDiv.innerHTML = '<div class="error-message">–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞–±—ñ–Ω–µ—Ç—É (–¥–µ–º–æ). –í—ñ–¥–∫—Ä–∏–π—Ç–µ Console —ñ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –ø–æ–º–∏–ª–∫—É.</div>';
                }
                return;
            }

            setLoading(true);
            window.__lastLoginDebug = { step: 'start', email };

            try {
                const { data, error } = await client.auth.signInWithPassword({ email, password });
                if (error) {
                    window.__lastLoginDebug = { step: 'signInWithPassword_error', email, error: error.message };
                    errorDiv.innerHTML = `<div class="error-message">${escapeHtml(error.message)}</div>`;
                    return;
                }

                // –Ü–Ω–æ–¥—ñ session –º–æ–∂–µ –±—É—Ç–∏ null (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Å–ø–µ—Ü. –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è/–º—É–ª—å—Ç–∏—Ñ–∞–∫—Ç–æ—Ä). –ü—ñ–¥—Å—Ç—Ä–∞—Ö—É—î–º–æ—Å—å.
                let session = data?.session || null;
                if (!session) {
                    const { data: s } = await client.auth.getSession();
                    session = s?.session || null;
                }

                if (!session || !session.user) {
                    window.__lastLoginDebug = { step: 'no_session_after_login', email };
                    errorDiv.innerHTML = '<div class="error-message">–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–µ—Å—ñ—é –ø—ñ—Å–ª—è –≤—Ö–æ–¥—É. –Ø–∫—â–æ –≤–∏ —â–æ–π–Ω–æ —Ä–µ—î—Å—Ç—Ä—É–≤–∞–ª–∏—Å—å ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è email —É –ø–æ—à—Ç—ñ. –Ø–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ MFA ‚Äî –ø–æ—Ç—Ä—ñ–±–Ω–µ –¥–æ–¥–∞—Ç–∫–æ–≤–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.</div>';
                    return;
                }

                window.__lastLoginDebug = { step: 'session_ok', email, user_id: session.user.id };
                await setCurrentUserFromSession(session);

                if (!currentUser) {
                    window.__lastLoginDebug = { step: 'currentUser_not_set', email };
                    errorDiv.innerHTML = '<div class="error-message">–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π, –∞–ª–µ –Ω–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –ô–º–æ–≤—ñ—Ä–Ω–æ, RLS-–ø–æ–ª—ñ—Ç–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ profiles –±–ª–æ–∫—É—é—Ç—å –¥–æ—Å—Ç—É–ø. –í—ñ–¥–∫—Ä–∏–π—Ç–µ Console —ñ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø–æ–º–∏–ª–∫–∞–º–∏.</div>';
                    return;
                }

                try {
                    showDashboard();
                } catch (e) {
                    console.error('showDashboard failed:', e);
                    window.__lastLoginDebug = { step: 'showDashboard_failed', email, err: String(e) };
                    errorDiv.innerHTML = '<div class="error-message">–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞–±—ñ–Ω–µ—Ç—É –ø—ñ—Å–ª—è –≤—Ö–æ–¥—É. –í—ñ–¥–∫—Ä–∏–π—Ç–µ Console —ñ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –ø–æ–º–∏–ª–∫—É (F12 ‚Üí Console).</div>';
                }
            } catch (err) {
                console.error('login() fatal:', err);
                window.__lastLoginDebug = { step: 'fatal', email, err: String(err) };
                errorDiv.innerHTML = `<div class="error-message">–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ${escapeHtml(String(err))}</div>`;
            } finally {
                setLoading(false);
            }
        }

        async function register() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;

            const errorDiv = document.getElementById('registerError');
            const successDiv = document.getElementById('registerSuccess');
            errorDiv.innerHTML = '';
            successDiv.innerHTML = '';

            if (!name || !email || !password || !passwordConfirm) {
                errorDiv.innerHTML = '<div class="error-message">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è</div>';
                return;
            }

            if (!validateEmail(email)) {
                errorDiv.innerHTML = '<div class="error-message">–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É email –∞–¥—Ä–µ—Å—É</div>';
                return;
            }

            if (password.length < 6) {
                errorDiv.innerHTML = '<div class="error-message">–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º–∞—Ç–∏ –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤</div>';
                return;
            }

            if (password !== passwordConfirm) {
                errorDiv.innerHTML = '<div class="error-message">–ü–∞—Ä–æ–ª—ñ –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å</div>';
                return;
            }

            const client = getSupabaseClient();
            if (!client) {
                // demo register
                const exists = Object.values(appData.users).some(u => u.email === email);
                if (exists) {
                    errorDiv.innerHTML = '<div class="error-message">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º email –≤–∂–µ —ñ—Å–Ω—É—î (–¥–µ–º–æ-—Ä–µ–∂–∏–º).</div>';
                    return;
                }
                const id = 'student_' + Date.now();
                appData.users[id] = { id, name, email, password, role: 'student' };
                currentUser = { ...appData.users[id] };
                successDiv.innerHTML = '<div class="success-message">–ê–∫–∞—É–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ (–¥–µ–º–æ-—Ä–µ–∂–∏–º).</div>';
                setTimeout(() => showDashboard(), 250);
                return;
            }

            try {
                const { data, error } = await client.auth.signUp({
                    email,
                    password,
                    options: {
                        data: { full_name: name },
                        emailRedirectTo: getAppUrl()
                    }
                });

                if (error) {
                    errorDiv.innerHTML = `<div class="error-message">${escapeHtml(error.message)}</div>`;
                    return;
                }

                if (!data.session) {
                    successDiv.innerHTML = '<div class="success-message">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–∞! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ—à—Ç—É —Ç–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å email, –ø–æ—Ç—ñ–º —É–≤—ñ–π–¥—ñ—Ç—å.</div>';
                    setTimeout(() => toggleAuth(), 1800);
                    return;
                }

                await upsertMyProfile({ full_name: name, role: 'student', legacy_id: null, can_add_students: false }, data.session.user.id);
                await setCurrentUserFromSession(data.session);
                showDashboard();

            } catch (err) {
                errorDiv.innerHTML = `<div class="error-message">–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: ${escapeHtml(String(err))}</div>`;
            }
        }

        function toggleAuth() {
            const loginForm = document.getElementById('loginForm');
            const regForm = document.getElementById('registerForm');
            const isLoginVisible = loginForm.style.display !== 'none';

            loginForm.style.display = isLoginVisible ? 'none' : 'block';
            regForm.style.display = isLoginVisible ? 'block' : 'none';

            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('regName').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regPasswordConfirm').value = '';

            document.getElementById('loginError').innerHTML = '';
            document.getElementById('registerError').innerHTML = '';
            document.getElementById('registerSuccess').innerHTML = '';
        }

        async function sendPasswordResetEmail(e) {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value.trim();
            const errorDiv = document.getElementById('resetError');
            const successDiv = document.getElementById('resetSuccess');
            errorDiv.innerHTML = '';
            successDiv.innerHTML = '';

            if (!email) {
                errorDiv.innerHTML = '<div class="error-message">–í–≤–µ–¥—ñ—Ç—å email</div>';
                return;
            }

            const client = getSupabaseClient();
            if (!client) {
                errorDiv.innerHTML = '<div class="error-message">–°–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø–Ω–µ –ª–∏—à–µ –∑ Supabase (–¥–µ–º–æ-—Ä–µ–∂–∏–º).</div>';
                return;
            }

            try {
                const { error } = await client.auth.resetPasswordForEmail(email, {
                    redirectTo: getAppUrl() + '?mode=recovery'
                });
                if (error) {
                    errorDiv.innerHTML = `<div class="error-message">${escapeHtml(error.message)}</div>`;
                    return;
                }
                successDiv.innerHTML = '<div class="success-message">–õ–∏—Å—Ç –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—é –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ—à—Ç—É.</div>';
            } catch (err) {
                errorDiv.innerHTML = `<div class="error-message">–ü–æ–º–∏–ª–∫–∞: ${escapeHtml(String(err))}</div>`;
            }
        }

        async function updatePasswordFromRecovery(e) {
            e.preventDefault();
            const pwd1 = document.getElementById('newPassword').value;
            const pwd2 = document.getElementById('newPassword2').value;
            const errorDiv = document.getElementById('resetNewPwdError');
            const successDiv = document.getElementById('resetNewPwdSuccess');
            errorDiv.innerHTML = '';
            successDiv.innerHTML = '';

            if (pwd1.length < 6) {
                errorDiv.innerHTML = '<div class="error-message">–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º–∞—Ç–∏ –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤</div>';
                return;
            }
            if (pwd1 !== pwd2) {
                errorDiv.innerHTML = '<div class="error-message">–ü–∞—Ä–æ–ª—ñ –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å</div>';
                return;
            }

            const client = getSupabaseClient();
            if (!client) {
                errorDiv.innerHTML = '<div class="error-message">–ó–º—ñ–Ω–∞ –ø–∞—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏—à–µ –∑ Supabase (–¥–µ–º–æ-—Ä–µ–∂–∏–º).</div>';
                return;
            }

            try {
                // Ensure we really have a recovery session before updating password
                const session = await ensureRecoverySession(client);
                if (!session) {
                    const details = __recoveryLastError ? `<div class="muted" style="margin-top:6px;">–î–µ—Ç–∞–ª—ñ: ${escapeHtml(__recoveryLastError)}</div>` : '';
                    errorDiv.innerHTML = `<div class="error-message">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—ó —Å–µ—Å—ñ—ó –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è. –ü–æ—Å–∏–ª–∞–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏:
                    <br>‚Ä¢ –≤—ñ–¥–∫—Ä–∏—Ç–æ –Ω–µ –≤ —Ç–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ (–≤–±—É–¥–æ–≤–∞–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä –ø–æ—à—Ç–∏/–º–µ—Å–µ–Ω–¥–∂–µ—Ä–∞),
                    <br>‚Ä¢ –∞–±–æ –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–µ / –∑–∞—Å—Ç–∞—Ä—ñ–ª–µ.
                    <br><br>‚úÖ –ó—Ä–æ–±—ñ—Ç—å —Ç–∞–∫: –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?¬ª —â–µ —Ä–∞–∑, –æ—Ç—Ä–∏–º–∞–π—Ç–µ –Ω–æ–≤–∏–π –ª–∏—Å—Ç —ñ –≤—ñ–¥–∫—Ä–∏–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —É —Ç–æ–º—É –∂ –±—Ä–∞—É–∑–µ—Ä—ñ, –¥–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–ª–∏ –∑–∞–ø–∏—Ç (–∞–±–æ —Å–∫–æ–ø—ñ—é–π—Ç–µ –ª—ñ–Ω–∫ —ñ –≤—Å—Ç–∞–≤—Ç–µ –≤ Chrome/Safari).${details}</div>`;
                    return;
                }

                const { error } = await client.auth.updateUser({ password: pwd1 });
                if (error) {
                    errorDiv.innerHTML = `<div class="error-message">${escapeHtml(error.message)}</div>`;
                    return;
                }

                successDiv.innerHTML = '<div class="success-message">–ü–∞—Ä–æ–ª—å —É—Å–ø—ñ—à–Ω–æ –∑–º—ñ–Ω–µ–Ω–æ! –ó–∞—Ä–∞–∑ –ø–æ–≤–µ—Ä–Ω–µ–º–æ –≤–∞—Å –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤—Ö–æ–¥—É.</div>';

                // –ü–û–í–ï–î–Ü–ù–ö–ê (1): –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –Ω–∞ –ª–æ–≥—ñ–Ω —ñ –ù–ï –ª–æ–≥—ñ–Ω–∏—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
                setTimeout(async () => {
                    try {
                        sessionStorage.setItem('pw_updated', '1');
                    } catch (_) {}

                    // –í–∞–∂–ª–∏–≤–æ: –ø—ñ—Å–ª—è recovery –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î —Å–µ—Å—ñ—é. –©–æ–± –Ω–µ –∑–∞–ª–æ–≥—ñ–Ω–∏—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ ‚Äî —Ä–æ–±–∏–º–æ signOut.
                    try {
                        await client.auth.signOut();
                    } catch (_) {}

                    stripHashFromUrl();
                    closeModal('passwordResetModal');
                    window.location.replace(getAppUrl());
                }, 700);

            } catch (err) {
                errorDiv.innerHTML = `<div class="error-message">–ü–æ–º–∏–ª–∫–∞: ${escapeHtml(String(err))}</div>`;
            }
        }

        async function logout() {
            const client = getSupabaseClient();
            if (client) {
                try { await client.auth.signOut(); } catch (_) {}
            }

            currentUser = null;
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('adminDashboard').classList.remove('active');
            document.getElementById('teacherDashboard').classList.remove('active');
            document.getElementById('studentDashboard').classList.remove('active');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // ========================
        //  NAV
        // ========================
        function showDashboard() {
            // Guard: —è–∫—â–æ currentUser –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–∏–≤—Å—è ‚Äî –Ω–µ –ø–∞–¥–∞—î–º–æ "—Ç–∏—Ö–æ"
            if (!currentUser || !currentUser.role) {
                const err = document.getElementById('loginError');
                if (err) err.innerHTML = '<div class="error-message">–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ –∫–∞–±—ñ–Ω–µ—Ç: currentUser –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ. –í—ñ–¥–∫—Ä–∏–π—Ç–µ Console (F12) —ñ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –ø–æ–º–∏–ª–∫–∏ –∞–±–æ –≤–∏–∫–æ–Ω–∞–π—Ç–µ debugAuth().</div>';
                console.error('showDashboard: currentUser is missing', currentUser);
                return;
            }

            document.getElementById('authScreen').style.display = 'none';

            if (currentUser.role === 'admin') {
                document.getElementById('adminDashboard').classList.add('active');
                document.getElementById('teacherDashboard').classList.remove('active');
                document.getElementById('studentDashboard').classList.remove('active');
                document.getElementById('adminName').textContent = currentUser.name;
                renderAdminView();
            } else if (currentUser.role === 'teacher') {
                currentUser.students = appData.users[currentUser.id]?.students || [];
                currentUser.canAddStudents = !!appData.users[currentUser.id]?.canAddStudents;
                document.getElementById('teacherDashboard').classList.add('active');
                document.getElementById('adminDashboard').classList.remove('active');
                document.getElementById('studentDashboard').classList.remove('active');
                document.getElementById('teacherName').textContent = currentUser.name;
                renderTeacherView();
            } else {
                document.getElementById('studentDashboard').classList.add('active');
                document.getElementById('adminDashboard').classList.remove('active');
                document.getElementById('teacherDashboard').classList.remove('active');
                document.getElementById('studentName').textContent = currentUser.name;
                renderStudentView();
            }
        }

        function switchTab(tabName, button) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }

        // ========================
        //  ADMIN
        // ========================
        function renderAdminView() {
            renderUsersList();
            renderAllAssignments();
        }

        function renderUsersList() {
            const list = document.getElementById('usersList');
            if (!list) return;
            list.innerHTML = Object.values(appData.users).map(user => `
                <div class="user-card">
                    <div class="user-info-text">
                        <strong>${escapeHtml(user.name)}</strong>
                        <small>${escapeHtml(user.email)}</small>
                        <div style="margin-top: 4px;">
                            <span class="role-badge ${escapeHtml(user.role)}">${user.role === 'admin' ? '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä' : user.role === 'teacher' ? '–í–∏–∫–ª–∞–¥–∞—á' : '–£—á–µ–Ω—å'}</span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn-small btn-small-secondary" type="button" onclick="openEditUserModal('${user.id}')">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                        ${user.role !== 'admin' ? `<button class="btn-small btn-small-secondary" type="button" onclick="deleteUser('${user.id}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function openEditUserModal(userId) {
            editingUserId = userId;
            const user = appData.users[userId];

            document.getElementById('editUserName').textContent = user.name;
            document.getElementById('editUserEmail').textContent = user.email;
            document.getElementById('editUserRole').value = user.role === 'admin' ? 'student' : user.role;

            const teacherDiv = document.getElementById('teacherAssignmentDiv');
            const roleSelect = document.getElementById('editUserRole');
            const permCheckbox = document.getElementById('teacherCanAddStudents');

            const applyTeacherUI = () => {
                if (!appData.users[userId].students) appData.users[userId].students = [];
                permCheckbox.checked = !!appData.users[userId].canAddStudents;
                renderAssignStudentsList(userId);
                teacherDiv.style.display = 'block';
            };

            roleSelect.onchange = () => {
                const role = roleSelect.value;
                if (role === 'teacher') applyTeacherUI();
                else teacherDiv.style.display = 'none';
            };

            if (roleSelect.value === 'teacher') applyTeacherUI();
            else teacherDiv.style.display = 'none';

            document.getElementById('editUserModal').classList.add('active');
        }

        function renderAssignStudentsList(userId) {
            const list = document.getElementById('assignStudentsList');
            const students = Object.values(appData.users).filter(u => u.role === 'student');
            const teacher = appData.users[userId];
            const teacherStudents = teacher.students || [];

            list.innerHTML = students.map(student => `
                <div style="padding: 8px; display: flex; gap: 10px; align-items: center;">
                    <input type="checkbox" id="student_${student.id}" value="${student.id}" ${teacherStudents.includes(student.id) ? 'checked' : ''}>
                    <label for="student_${student.id}">${escapeHtml(student.name)} (${escapeHtml(student.email)})</label>
                </div>
            `).join('');
        }

        function saveUserChanges(e) {
            e.preventDefault();
            const newRole = document.getElementById('editUserRole').value;
            const user = appData.users[editingUserId];
            user.role = newRole;

            if (newRole === 'teacher') {
                const checkboxes = document.querySelectorAll('#assignStudentsList input[type="checkbox"]');
                const selectedStudents = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                user.students = selectedStudents;
                user.canAddStudents = !!document.getElementById('teacherCanAddStudents').checked;
            } else {
                delete user.students;
                delete user.canAddStudents;
            }

            closeModal('editUserModal');
            renderAdminView();
        }

        function deleteUser(userId) {
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?')) {
                delete appData.users[userId];
                delete appData.personalNotes[userId];
                renderAdminView();
            }
        }

        function renderAllAssignments() {
            const list = document.getElementById('allAssignmentsList');
            if (!list) return;
            list.innerHTML = appData.assignments.map(assign => {
                const teacher = appData.users[assign.teacherId];
                return `
                    <div class="assignment">
                        <h4>${escapeHtml(assign.title)}</h4>
                        <p>${escapeHtml(assign.description || '')}</p>
                        <small>–í–∏–∫–ª–∞–¥–∞—á: ${teacher ? escapeHtml(teacher.name) : 'N/A'}</small><br>
                        <small>–î–∞—Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: ${escapeHtml(assign.deadline || '')}</small>
                    </div>
                `;
            }).join('') || '<p style="color: #999;">–ó–∞–≤–¥–∞–Ω—å –Ω–µ–º–∞—î</p>';
        }

        // ========================
        //  TEACHER
        // ========================
        function renderTeacherView() {
            renderCalendar();
            renderScheduleList();
            renderTeacherStudentsList();
        }

        window.selectedDate = null;
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();

        function renderCalendar() {
            const currentMonth = currentCalendarMonth;
            const currentYear = currentCalendarYear;

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            const monthNames = ['–°—ñ—á–µ–Ω—å','–õ—é—Ç–∏–π','–ë–µ—Ä–µ–∑–µ–Ω—å','–ö–≤—ñ—Ç–µ–Ω—å','–¢—Ä–∞–≤–µ–Ω—å','–ß–µ—Ä–≤–µ–Ω—å','–õ–∏–ø–µ–Ω—å','–°–µ—Ä–ø–µ–Ω—å','–í–µ—Ä–µ—Å–µ–Ω—å','–ñ–æ–≤—Ç–µ–Ω—å','–õ–∏—Å—Ç–æ–ø–∞–¥','–ì—Ä—É–¥–µ–Ω—å'];
            const dayNames = ['–ù–¥','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];

            const teacherSchedule = appData.schedule.filter(s => s.teacherId === currentUser.id);
            const scheduledDates = new Set(teacherSchedule.map(s => s.date));

            let html = `
                <div class="calendar">
                    <div class="calendar-header">
                        <div class="calendar-controls">
                            <button type="button" onclick="changeMonth(-1)">‚Üê</button>
                            <span id="monthYearDisplay">${monthNames[currentMonth]} ${currentYear}</span>
                            <button type="button" onclick="changeMonth(1)">‚Üí</button>
                        </div>
                    </div>
                    <div class="weekdays">
                        ${dayNames.map(day => `<div class="weekday">${day}</div>`).join('')}
                    </div>
                    <div class="days">
            `;

            const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                html += `<div class="day other-month">${prevMonthLastDay - i}</div>`;
            }

            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const hasSchedule = scheduledDates.has(dateStr);
                const isSelected = window.selectedDate === dateStr;
                const isToday = dateStr === todayStr;

                html += `<div class="day ${isSelected ? 'selected' : ''} ${hasSchedule ? 'has-schedule' : ''}" onclick="selectScheduleDate('${dateStr}')" style="${isToday ? 'border: 2px solid var(--color-primary);' : ''}">${day}</div>`;
            }

            const totalCells = Math.ceil((startingDayOfWeek + daysInMonth) / 7) * 7;
            for (let day = 1; day <= totalCells - startingDayOfWeek - daysInMonth; day++) {
                html += `<div class="day other-month">${day}</div>`;
            }

            html += `</div></div>`;
            document.getElementById('calendarContainer').innerHTML = html;
        }

        function changeMonth(offset) {
            currentCalendarMonth += offset;
            if (currentCalendarMonth > 11) { currentCalendarMonth = 0; currentCalendarYear++; }
            else if (currentCalendarMonth < 0) { currentCalendarMonth = 11; currentCalendarYear--; }

            window.selectedDate = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-01`;
            renderCalendar();
            renderScheduleListForDate(window.selectedDate);
        }

        function selectScheduleDate(dateStr) {
            window.selectedDate = dateStr;
            renderCalendar();
            renderScheduleListForDate(dateStr);
        }

        function renderScheduleList() {
            if (!window.selectedDate) {
                const today = new Date();
                currentCalendarMonth = today.getMonth();
                currentCalendarYear = today.getFullYear();
                window.selectedDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            }

            const [y, m] = window.selectedDate.split('-');
            currentCalendarYear = Number(y);
            currentCalendarMonth = Number(m) - 1;

            renderCalendar();
            renderScheduleListForDate(window.selectedDate);
        }

        function renderScheduleListForDate(dateStr) {
            const list = document.getElementById('scheduleList');
            const teacherSchedule = appData.schedule.filter(s => s.teacherId === currentUser.id && s.date === dateStr);

            const dateObj = new Date(dateStr + 'T00:00:00');
            const dayNames = ['–Ω–µ–¥—ñ–ª—è','–ø–æ–Ω–µ–¥—ñ–ª–æ–∫','–≤—ñ–≤—Ç–æ—Ä–æ–∫','—Å–µ—Ä–µ–¥–∞','—á–µ—Ç–≤–µ—Ä','–ø\'—è—Ç–Ω–∏—Ü—è','—Å—É–±–æ—Ç–∞'];
            const monthNames = ['—Å—ñ—á–Ω—è','–ª—é—Ç–æ–≥–æ','–±–µ—Ä–µ–∑–Ω—è','–∫–≤—ñ—Ç–Ω—è','—Ç—Ä–∞–≤–Ω—è','—á–µ—Ä–≤–Ω—è','–ª–∏–ø–Ω—è','—Å–µ—Ä–ø–Ω—è','–≤–µ—Ä–µ—Å–Ω—è','–∂–æ–≤—Ç–Ω—è','–ª–∏—Å—Ç–æ–ø–∞–¥–∞','–≥—Ä—É–¥–Ω—è'];
            const dayName = dayNames[dateObj.getDay()];
            const monthName = monthNames[dateObj.getMonth()];
            const day = dateObj.getDate();

            list.innerHTML = `<div class="schedule-day-header">${dayName}, ${day} ${monthName}</div>`;

            if (teacherSchedule.length === 0) {
                list.innerHTML += '<p style="color: #999;">–ù–∞ —Ü–µ–π –¥–µ–Ω—å –∑–∞–Ω—è—Ç—å –Ω–µ–º–∞—î</p>';
                return;
            }

            list.innerHTML += teacherSchedule.map(sched => {
                const studentNames = (sched.studentIds || []).map(id => appData.users[id]?.name).filter(Boolean).join(', ');
                const statusEmoji = sched.status === 'completed' ? '‚úÖ' : sched.status === 'cancelled' ? '‚ùå' : sched.status === 'postponed' ? '‚è≥' : '';
                return `
                    <div class="schedule-item">
                        <div class="schedule-info">
                            <strong>${escapeHtml(sched.name)}</strong>
                            <small>${escapeHtml(sched.time)}</small>
                            <small style="color: var(--color-primary); margin-top: 4px; display: block;">${escapeHtml(studentNames || '–Ω–µ–º–∞—î —É—á–Ω—ñ–≤')}</small>
                            ${statusEmoji ? `<small style="font-size: 16px; margin-top: 4px;">${statusEmoji}</small>` : ''}
                        </div>
                        <div class="schedule-platform" style="display:flex; gap: 10px; align-items:center; flex-wrap:wrap;">
                            <span class="badge badge-platform">${escapeHtml(sched.platform)}</span>
                            ${sched.link ? `<a href="${escapeHtml(sched.link)}" target="_blank" rel="noopener" style="color: var(--color-primary); text-decoration: underline;">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</a>` : ''}
                        </div>
                        <div style="display: flex; gap: 10px; flex-direction: column;">
                            <div style="display: flex; gap: 10px; flex-wrap:wrap;">
                                <button class="btn-small btn-small-secondary" type="button" onclick="editSchedule('${sched.id}')">‚úèÔ∏è</button>
                                <button class="btn-small btn-small-secondary" type="button" onclick="deleteSchedule('${sched.id}')">üóëÔ∏è</button>
                            </div>
                            <div style="display: flex; gap: 6px; font-size: 12px; flex-wrap:wrap;">
                                <button class="btn-small" type="button" style="background: var(--color-success); color: white;" onclick="setScheduleStatus('${sched.id}', 'completed')" title="–ü—Ä–æ–≤–µ–¥–µ–Ω–æ">‚úÖ –ü—Ä–æ–≤–µ–¥–µ–Ω–æ</button>
                                <button class="btn-small" type="button" style="background: var(--color-danger); color: white;" onclick="setScheduleStatus('${sched.id}', 'cancelled')" title="–°–∫–∞—Å–æ–≤–∞–Ω–æ">‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ</button>
                                <button class="btn-small" type="button" style="background: var(--color-warning); color: white;" onclick="setScheduleStatus('${sched.id}', 'postponed')" title="–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ">‚è≥ –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderScheduleStudentsCheckboxes(selectedStudentIds = []) {
            const container = document.getElementById('schedStudentsCheckboxes');
            const allStudents = Object.values(appData.users).filter(u => u.role === 'student');

            if (allStudents.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 12px;">–£ —Å–∏—Å—Ç–µ–º—ñ –Ω–µ–º–∞—î —É—á–Ω—ñ–≤</p>';
                return;
            }

            container.innerHTML = allStudents.map(student => `
                <div style="padding: 8px; display: flex; gap: 10px; align-items: center;">
                    <input type="checkbox" id="schedStudent_${student.id}" value="${student.id}" class="schedStudentCheckbox" ${selectedStudentIds.includes(student.id) ? 'checked' : ''}>
                    <label for="schedStudent_${student.id}" style="margin: 0; cursor: pointer;">${escapeHtml(student.name)}</label>
                </div>
            `).join('');
        }

        function getSelectedScheduleStudents() {
            const checkboxes = document.querySelectorAll('.schedStudentCheckbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function openAddScheduleModal() {
            editingScheduleId = null;
            document.getElementById('schedName').value = '';
            document.getElementById('schedDate').value = '';
            setTimePickers(getRoundedTime5());
            document.getElementById('schedPlatform').value = '';
            document.getElementById('schedLink').value = '';
            renderScheduleStudentsCheckboxes([]);
            document.getElementById('addScheduleModal').classList.add('active');
        }

        function saveSchedule(e) {
            e.preventDefault();
            const studentIds = getSelectedScheduleStudents();
            const schedule = {
                id: editingScheduleId || 'sched_' + Date.now(),
                name: document.getElementById('schedName').value,
                date: document.getElementById('schedDate').value,
                time: getTimeFromPickers(),
                platform: document.getElementById('schedPlatform').value,
                link: document.getElementById('schedLink').value,
                teacherId: currentUser.id,
                studentIds: studentIds,
                status: 'pending'
            };

            if (editingScheduleId) {
                const index = appData.schedule.findIndex(s => s.id === editingScheduleId);
                const existingStatus = appData.schedule[index]?.status;
                schedule.status = existingStatus || 'pending';
                appData.schedule[index] = schedule;
            } else {
                appData.schedule.push(schedule);
            }

            if (!currentUser.students) currentUser.students = [];
            studentIds.forEach(id => { if (!currentUser.students.includes(id)) currentUser.students.push(id); });
            appData.users[currentUser.id].students = currentUser.students;

            closeModal('addScheduleModal');
            renderTeacherView();
        }

        function editSchedule(id) {
            const sched = appData.schedule.find(s => s.id === id);
            if (!sched) return;
            editingScheduleId = id;
            document.getElementById('schedName').value = sched.name;
            document.getElementById('schedDate').value = sched.date;
            setTimePickers(sched.time);
            document.getElementById('schedPlatform').value = sched.platform;
            document.getElementById('schedLink').value = sched.link || '';
            renderScheduleStudentsCheckboxes(sched.studentIds || []);
            document.getElementById('addScheduleModal').classList.add('active');
        }

        function deleteSchedule(id) {
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–Ω—è—Ç—Ç—è?')) {
                appData.schedule = appData.schedule.filter(s => s.id !== id);
                renderTeacherView();
            }
        }

        function setScheduleStatus(id, status) {
            const sched = appData.schedule.find(s => s.id === id);
            if (sched) {
                sched.status = status;
                renderTeacherView();
            }
        }

        function renderTeacherStudentsList() {
            const list = document.getElementById('teacherStudentsList');
            const actions = document.getElementById('teacherStudentsTopActions');
            const canAdd = !!appData.users[currentUser.id]?.canAddStudents;

            actions.innerHTML = canAdd
                ? `<button class="btn-small btn-small-primary" type="button" onclick="openAddStudentsToTeacherModal()">+ –î–æ–¥–∞—Ç–∏ —É—á–Ω—è</button>`
                : `<span class="pill">üîí –î–æ–¥–∞–≤–∞–Ω–Ω—è —É—á–Ω—ñ–≤ –≤–∏–º–∫–Ω–µ–Ω–æ (–ø–æ—Ç—Ä—ñ–±–Ω–µ –ø—Ä–∞–≤–æ –≤—ñ–¥ –∞–¥–º—ñ–Ω–∞)</span>`;

            const studentIds = new Set([...(appData.users[currentUser.id]?.students || [])]);
            appData.schedule
                .filter(s => s.teacherId === currentUser.id)
                .forEach(s => (s.studentIds || []).forEach(id => studentIds.add(id)));

            const students = Array.from(studentIds)
                .map(id => appData.users[id])
                .filter(u => u && u.role === 'student');

            list.innerHTML = students.map(student => {
                const note = appData.personalNotes[student.id];
                return `
                    <div class="student-item" style="border-left-color: var(--color-info);">
                        <div style="display:flex; justify-content: space-between; gap: 10px; align-items: flex-start;">
                            <div style="flex:1;">
                                <strong>${escapeHtml(student.name)}</strong>
                                <small>${escapeHtml(student.email)}</small>
                                ${note ? `<div class="muted" style="margin-top: 6px;">üóíÔ∏è ${escapeHtml(note)}</div>` : ''}
                            </div>
                            <div style="display:flex; gap: 8px;">
                                <button class="btn-small btn-small-primary" type="button" onclick="openStudentDetail('${student.id}')">–í—ñ–¥–∫—Ä–∏—Ç–∏</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<p style="color: #999;">–£ –≤–∞—Å –Ω–µ–º–∞—î —É—á–Ω—ñ–≤</p>';
        }

        // ========================
        //  TEACHER -> STUDENT DETAIL
        // ========================
        let selectedTeacherStudentId = null;

        function switchStudentDetailTab(tabName, button) {
            document.querySelectorAll('.tab-content-sd').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelectorAll('.tab-button-sd').forEach(b => b.classList.remove('active'));
            button.classList.add('active');
        }

        function getLessonsForStudent(teacherId, studentId) {
            return appData.schedule
                .filter(s => s.teacherId === teacherId && (s.studentIds || []).includes(studentId))
                .sort((a, b) => parseDateTime(a.date, a.time) - parseDateTime(b.date, b.time));
        }

        function getUpcomingLessonsForStudent(teacherId, studentId, limit = 6) {
            const now = new Date();
            return getLessonsForStudent(teacherId, studentId)
                .filter(s => parseDateTime(s.date, s.time) >= now)
                .slice(0, limit);
        }

        function getHomeworkForStudent(teacherId, studentId) {
            return appData.assignments
                .filter(a => a.teacherId === teacherId && ((a.studentIds || []).includes(studentId) || (a.studentStatus && a.studentStatus[studentId] !== undefined)))
                .sort((a, b) => (a.deadline || '').localeCompare(b.deadline || ''));
        }

        function getMaterialsForStudent(studentId) {
            return (appData.studentMaterials[studentId] || []).slice().sort((a, b) => (b.date || '').localeCompare(a.date || ''));
        }

        function openStudentDetail(studentId) {
            selectedTeacherStudentId = studentId;
            const student = appData.users[studentId];
            document.getElementById('studentDetailTitle').textContent = `üë§ ${student.name} ‚Äî —É—á–µ–Ω—å`;

            document.querySelectorAll('.tab-button-sd').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content-sd').forEach(t => t.classList.remove('active'));
            document.querySelector('.tab-button-sd').classList.add('active');
            document.getElementById('sd_lessons').classList.add('active');

            renderStudentDetailLessons();
            renderStudentDetailHomework();
            renderStudentDetailMaterials();

            document.getElementById('studentDetailModal').classList.add('active');
        }

        function renderStudentDetailLessons() {
            const container = document.getElementById('sd_lessons');
            const studentId = selectedTeacherStudentId;
            const upcoming = getUpcomingLessonsForStudent(currentUser.id, studentId);

            container.innerHTML = `
                <div class="card" style="margin-bottom: 0;">
                    <h3>–ù–∞–π–±–ª–∏–∂—á—ñ –∑–∞–Ω—è—Ç—Ç—è</h3>
                    ${upcoming.length === 0 ? `<p class="muted">–ù–∞–π–±–ª–∏–∂—á–∏—Ö –∑–∞–Ω—è—Ç—å –Ω–µ–º–∞—î.</p>` : ''}
                    ${upcoming.map(s => {
                        const statusEmoji = s.status === 'completed' ? '‚úÖ' : s.status === 'cancelled' ? '‚ùå' : s.status === 'postponed' ? '‚è≥' : '';
                        return `
                            <div class="schedule-item" style="grid-template-columns: 1.2fr 1fr 1fr;">
                                <div class="schedule-info">
                                    <strong>${escapeHtml(s.name)}</strong>
                                    <small>${formatDateUA(s.date)} ‚Ä¢ ${escapeHtml(s.time)} ${statusEmoji ? '‚Ä¢ ' + statusEmoji : ''}</small>
                                </div>
                                <div class="schedule-platform" style="display:flex; gap: 10px; align-items:center; flex-wrap:wrap;">
                                    <span class="badge badge-platform">${escapeHtml(s.platform)}</span>
                                    ${s.link ? `<a href="${escapeHtml(s.link)}" target="_blank" rel="noopener" style="color: var(--color-primary); text-decoration: underline;">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</a>` : ''}
                                </div>
                                <div class="inline-actions">
                                    <button class="btn-small btn-small-secondary" type="button" onclick="prefillMaterialForLesson('${s.id}')">‚ûï –ú–∞—Ç–µ—Ä—ñ–∞–ª</button>
                                    <button class="btn-small btn-small-secondary" type="button" onclick="prefillHomeworkForLesson('${s.id}')">‚ûï –î/–ó</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function prefillHomeworkForLesson(lessonId) {
            const btn = document.querySelectorAll('.tab-button-sd')[1];
            switchStudentDetailTab('sd_homework', btn);
            const lesson = appData.schedule.find(s => s.id === lessonId);
            if (!lesson) return;
            document.getElementById('sdHwLinkedLesson').value = lessonId;
            document.getElementById('sdHwTitle').value = `–î/–ó –ø—ñ—Å–ª—è –∑–∞–Ω—è—Ç—Ç—è: ${lesson.name}`;
            const d = new Date(lesson.date + 'T00:00:00');
            d.setDate(d.getDate() + 1);
            document.getElementById('sdHwDeadline').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function prefillMaterialForLesson(lessonId) {
            const btn = document.querySelectorAll('.tab-button-sd')[2];
            switchStudentDetailTab('sd_materials', btn);
            const lesson = appData.schedule.find(s => s.id === lessonId);
            if (!lesson) return;
            document.getElementById('sdMatLinkedLesson').value = lessonId;
            document.getElementById('sdMatTitle').value = `–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –¥–æ –∑–∞–Ω—è—Ç—Ç—è: ${lesson.name}`;
            document.getElementById('sdMatDate').value = lesson.date;
        }

        function getStatusLabel(status) {
            if (status === 'completed') return '‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ';
            if (status === 'in_progress') return '‚è≥ –í –ø—Ä–æ—Ü–µ—Å—ñ';
            return '‚ùå –ù–µ –ø–æ—á–∞—Ç–æ';
        }

        function renderStudentDetailHomework() {
            const container = document.getElementById('sd_homework');
            const studentId = selectedTeacherStudentId;
            const student = appData.users[studentId];
            const homework = getHomeworkForStudent(currentUser.id, studentId);
            const lessons = getLessonsForStudent(currentUser.id, studentId);

            const lessonOptions = `<option value="">(–±–µ–∑ –ø—Ä–∏–≤'—è–∑–∫–∏)</option>` + lessons.map(s => {
                const label = `${formatDateUA(s.date)} ${s.time} ‚Äî ${s.name}`;
                return `<option value="${s.id}">${escapeHtml(label)}</option>`;
            }).join('');

            container.innerHTML = `
                <div class="card" style="margin-bottom: 15px;">
                    <h3>–î–æ–¥–∞—Ç–∏ –¥–æ–º–∞—à–Ω—î –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è ${escapeHtml(student.name)}</h3>
                    <form onsubmit="addHomeworkForStudent(event)">
                        <div class="two-col">
                            <div class="form-group">
                                <label>–ù–∞–∑–≤–∞</label>
                                <input id="sdHwTitle" type="text" required placeholder="–ù–∞–ø—Ä.: –í–ø—Ä–∞–≤–∞ 5, —Å—Ç–æ—Ä. 12" />
                            </div>
                            <div class="form-group">
                                <label>–î–µ–¥–ª–∞–π–Ω</label>
                                <input id="sdHwDeadline" type="date" required />
                            </div>
                        </div>
                        <div class="form-group">
                            <label>–û–ø–∏—Å</label>
                            <textarea id="sdHwDesc" placeholder="–©–æ —Å–∞–º–µ —Ç—Ä–µ–±–∞ –∑—Ä–æ–±–∏—Ç–∏..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>–§–∞–π–ª–∏ –¥–æ –î/–ó (–¥–µ–º–æ ‚Äî –∑–±–µ—Ä–µ–∂–µ–º–æ –ª–∏—à–µ –Ω–∞–∑–≤–∏)</label>
                            <input id="sdHwFiles" type="file" multiple accept=".txt,doc,docx,pdf,jpg,jpeg,png,gif,zip" />
                            <div class="muted">* –£ –¥–µ–º–æ —Ñ–∞–π–ª–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Äî –∑–±–µ—Ä–µ–∂–µ–º–æ –ª–∏—à–µ –Ω–∞–∑–≤–∏.</div>
                        </div>
                        <div class="form-group">
                            <label>–ü—Ä–∏–≤‚Äô—è–∑–∞—Ç–∏ –¥–æ –∑–∞–Ω—è—Ç—Ç—è</label>
                            <select id="sdHwLinkedLesson">${lessonOptions}</select>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-small btn-small-primary" type="submit">+ –î–æ–¥–∞—Ç–∏ –î/–ó</button>
                            <span class="muted">–£—á–µ–Ω—å –ø–æ–±–∞—á–∏—Ç—å —Ü–µ —É –≤–∫–ª–∞–¥—Ü—ñ ‚Äú–ó–∞–≤–¥–∞–Ω–Ω—è‚Äù.</span>
                        </div>
                    </form>
                </div>

                <div class="card" style="margin-bottom: 0;">
                    <h3>–°–ø–∏—Å–æ–∫ –¥–æ–º–∞—à–Ω—ñ—Ö</h3>
                    ${homework.length === 0 ? `<p class="muted">–î–æ–º–∞—à–Ω—ñ—Ö –∑–∞–≤–¥–∞–Ω—å –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>` : ''}
                    ${homework.map(a => {
                        const status = (a.studentStatus && a.studentStatus[studentId]) ? a.studentStatus[studentId] : 'not_started';
                        const comment = (a.studentComments && a.studentComments[studentId]) ? a.studentComments[studentId] : '';
                        const submission = a.studentSubmissions ? a.studentSubmissions[studentId] : null;
                        const linked = a.linkedLessonId ? appData.schedule.find(s => s.id === a.linkedLessonId) : null;

                        return `
                            <div class="assignment" style="border-left-color: var(--color-info);">
                                <h4 style="margin-bottom: 6px;">${escapeHtml(a.title)}</h4>
                                <div class="assignment-meta" style="margin-bottom: 8px;">
                                    <small>üìÖ –î–µ–¥–ª–∞–π–Ω: ${a.deadline ? formatDateUA(a.deadline) : '-'}</small>
                                    <small>–°—Ç–∞—Ç—É—Å: <span class="status-${escapeHtml(status)}">${getStatusLabel(status)}</span></small>
                                    ${linked ? `<small>üîó ${formatDateUA(linked.date)} ‚Ä¢ ${escapeHtml(linked.name)}</small>` : ''}
                                </div>
                                ${a.description ? `<p style="margin: 0 0 10px 0;">${escapeHtml(a.description)}</p>` : ''}

                                ${a.teacherFiles && a.teacherFiles.length ? `
                                    <div style="background:#fff; border: 1px dashed var(--color-border); padding: 10px; border-radius: var(--radius); margin-bottom: 10px;">
                                        <div class="muted"><strong>üìé –§–∞–π–ª–∏ –≤—ñ–¥ –≤–∏–∫–ª–∞–¥–∞—á–∞:</strong> ${a.teacherFiles.map(escapeHtml).join(', ')}</div>
                                    </div>
                                ` : ''}

                                ${submission ? `
                                    <div style="background:#fff; border: 1px dashed var(--color-border); padding: 10px; border-radius: var(--radius); margin-bottom: 10px;">
                                        <div class="muted"><strong>üì§ –ó–¥–∞—á–∞ —É—á–Ω—è:</strong> ${escapeHtml(submission.date || '')}</div>
                                        ${submission.text ? `<div style="margin-top:6px;">${escapeHtml(String(submission.text)).replace(/\n/g,'<br>')}</div>` : ''}
                                        ${submission.files && submission.files.length ? `<div class="muted" style="margin-top:6px;">–§–∞–π–ª–∏: ${submission.files.map(escapeHtml).join(', ')}</div>` : ''}
                                    </div>
                                ` : `<div class="muted" style="margin-bottom: 10px;">–£—á–µ–Ω—å —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞–≤ —Ä—ñ—à–µ–Ω–Ω—è.</div>`}

                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label style="font-size: 12px;">–ö–æ–º–µ–Ω—Ç–∞—Ä –≤–∏–∫–ª–∞–¥–∞—á–∞</label>
                                    <textarea id="comment_${a.id}" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä...">${escapeHtml(comment || '')}</textarea>
                                </div>
                                <div class="inline-actions">
                                    <button class="btn-small btn-small-secondary" type="button" onclick="saveTeacherComment('${a.id}')">üí¨ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä</button>
                                    <button class="btn-small btn-small-secondary" type="button" onclick="deleteHomework('${a.id}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            const dl = document.getElementById('sdHwDeadline');
            if (dl && !dl.value) {
                const d = new Date();
                d.setDate(d.getDate() + 1);
                dl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            }
        }

        function addHomeworkForStudent(e) {
            e.preventDefault();
            const studentId = selectedTeacherStudentId;

            const title = document.getElementById('sdHwTitle').value.trim();
            const deadline = document.getElementById('sdHwDeadline').value;
            const description = document.getElementById('sdHwDesc').value.trim();
            const linkedLessonId = document.getElementById('sdHwLinkedLesson').value || '';

            const hwFiles = document.getElementById('sdHwFiles')?.files;
            const hwFileNames = hwFiles ? Array.from(hwFiles).map(f => f.name) : [];

            const id = 'assign_' + Date.now();
            appData.assignments.push({
                id,
                title,
                description,
                deadline,
                teacherId: currentUser.id,
                studentIds: [studentId],
                linkedLessonId: linkedLessonId || null,
                teacherFiles: hwFileNames,
                studentStatus: { [studentId]: 'not_started' },
                studentComments: { [studentId]: '' },
                studentSubmissions: {}
            });

            renderStudentDetailHomework();
            renderAllAssignments();
        }

        function saveTeacherComment(assignmentId) {
            const studentId = selectedTeacherStudentId;
            const a = appData.assignments.find(x => x.id === assignmentId);
            if (!a) return;
            if (!a.studentComments) a.studentComments = {};
            a.studentComments[studentId] = document.getElementById('comment_' + assignmentId).value;
            alert('–ö–æ–º–µ–Ω—Ç–∞—Ä –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
        }

        function deleteHomework(assignmentId) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –¥–æ–º–∞—à–Ω—î –∑–∞–≤–¥–∞–Ω–Ω—è?')) return;
            appData.assignments = appData.assignments.filter(a => a.id !== assignmentId);
            renderStudentDetailHomework();
            renderAllAssignments();
        }

        function renderStudentDetailMaterials() {
            const container = document.getElementById('sd_materials');
            const studentId = selectedTeacherStudentId;
            const student = appData.users[studentId];
            const materials = getMaterialsForStudent(studentId);
            const lessons = getLessonsForStudent(currentUser.id, studentId);

            const lessonOptions = `<option value="">(–±–µ–∑ –ø—Ä–∏–≤'—è–∑–∫–∏)</option>` + lessons.map(s => {
                const label = `${formatDateUA(s.date)} ${s.time} ‚Äî ${s.name}`;
                return `<option value="${s.id}">${escapeHtml(label)}</option>`;
            }).join('');

            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

            container.innerHTML = `
                <div class="card" style="margin-bottom: 15px;">
                    <h3>–î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª –¥–ª—è ${escapeHtml(student.name)}</h3>
                    <form onsubmit="addMaterialForStudent(event)">
                        <div class="two-col">
                            <div class="form-group">
                                <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                                <input id="sdMatTitle" type="text" required placeholder="–ù–∞–ø—Ä.: –ö–æ–Ω—Å–ø–µ–∫—Ç + –≤–ø—Ä–∞–≤–∏" />
                            </div>
                            <div class="form-group">
                                <label>–î–∞—Ç–∞</label>
                                <input id="sdMatDate" type="date" value="${todayStr}" required />
                            </div>
                        </div>
                        <div class="form-group">
                            <label>–û–ø–∏—Å / —Ç–µ–∫—Å—Ç</label>
                            <textarea id="sdMatDesc" placeholder="–ü–æ—è—Å–Ω–µ–Ω–Ω—è, –ø–æ—Å–∏–ª–∞–Ω–Ω—è, –Ω–æ—Ç–∞—Ç–∫–∏..."></textarea>
                        </div>
                        <div class="two-col">
                            <div class="form-group">
                                <label>–ü—Ä–∏–≤‚Äô—è–∑–∞—Ç–∏ –¥–æ –∑–∞–Ω—è—Ç—Ç—è</label>
                                <select id="sdMatLinkedLesson">${lessonOptions}</select>
                            </div>
                            <div class="form-group">
                                <label>–§–∞–π–ª–∏ (–Ω–∞–∑–≤–∏ –∑–±–µ—Ä–µ–∂–µ–º–æ —è–∫ –¥–µ–º–æ)</label>
                                <input id="sdMatFiles" type="file" multiple accept=".txt,doc,docx,pdf,jpg,jpeg,png,gif,zip" />
                                <div class="muted">* –£ —Ü—å–æ–º—É –¥–µ–º–æ —Ñ–∞–π–ª–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Äî –∑–±–µ—Ä–µ–∂–µ–º–æ –ª–∏—à–µ –Ω–∞–∑–≤–∏.</div>
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-small btn-small-primary" type="submit">+ –î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª</button>
                            <span class="muted">–£—á–µ–Ω—å –ø–æ–±–∞—á–∏—Ç—å —Ü–µ —É –≤–∫–ª–∞–¥—Ü—ñ ‚Äú–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏‚Äù.</span>
                        </div>
                    </form>
                </div>

                <div class="card" style="margin-bottom: 0;">
                    <h3>–°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤</h3>
                    ${materials.length === 0 ? `<p class="muted">–ú–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>` : ''}
                    ${materials.map(m => {
                        const linked = m.scheduleId ? appData.schedule.find(s => s.id === m.scheduleId) : null;
                        return `
                            <div class="assignment" style="border-left-color: var(--color-success);">
                                <h4 style="margin-bottom: 6px;">${escapeHtml(m.title)}</h4>
                                <div class="assignment-meta" style="margin-bottom: 8px;">
                                    <small>üìÖ ${m.date ? formatDateUA(m.date) : ''}</small>
                                    ${linked ? `<small>üîó ${formatDateUA(linked.date)} ‚Ä¢ ${escapeHtml(linked.name)}</small>` : ''}
                                </div>
                                ${m.description ? `<p style="margin: 0 0 10px 0;">${escapeHtml(m.description)}</p>` : ''}
                                ${m.files && m.files.length ? `
                                    <div style="background:#fff; border: 1px dashed var(--color-border); padding: 10px; border-radius: var(--radius); margin-bottom: 10px;">
                                        <div class="muted"><strong>üìé –§–∞–π–ª–∏:</strong> ${m.files.map(escapeHtml).join(', ')}</div>
                                    </div>
                                ` : ''}
                                <div class="inline-actions">
                                    <button class="btn-small btn-small-secondary" type="button" onclick="deleteMaterial('${m.id}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function addMaterialForStudent(e) {
            e.preventDefault();
            const studentId = selectedTeacherStudentId;

            const title = document.getElementById('sdMatTitle').value.trim();
            const date = document.getElementById('sdMatDate').value;
            const description = document.getElementById('sdMatDesc').value.trim();
            const scheduleId = document.getElementById('sdMatLinkedLesson').value || null;
            const files = document.getElementById('sdMatFiles').files;
            const fileNames = Array.from(files).map(f => f.name);

            const item = { id: 'mat_' + Date.now(), title, date, description, scheduleId, files: fileNames };
            if (!appData.studentMaterials[studentId]) appData.studentMaterials[studentId] = [];
            appData.studentMaterials[studentId].push(item);

            renderStudentDetailMaterials();
        }

        function deleteMaterial(materialId) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –º–∞—Ç–µ—Ä—ñ–∞–ª?')) return;
            const studentId = selectedTeacherStudentId;
            appData.studentMaterials[studentId] = (appData.studentMaterials[studentId] || []).filter(m => m.id !== materialId);
            renderStudentDetailMaterials();
        }

        // Teacher: add students to own list
        function openAddStudentsToTeacherModal() {
            if (!appData.users[currentUser.id]?.canAddStudents) {
                alert('–£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤–∞ –¥–æ–¥–∞–≤–∞—Ç–∏ —É—á–Ω—ñ–≤. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
                return;
            }
            renderAddStudentsToTeacherCheckboxes();
            document.getElementById('addStudentToTeacherModal').classList.add('active');
        }

        function renderAddStudentsToTeacherCheckboxes() {
            const container = document.getElementById('addTeacherStudentsCheckboxes');
            const hint = document.getElementById('addTeacherStudentsHint');
            const existing = new Set(appData.users[currentUser.id]?.students || []);

            const allStudents = Object.values(appData.users).filter(u => u.role === 'student');
            const available = allStudents.filter(s => !existing.has(s.id));

            hint.textContent = available.length
                ? '–û–±–µ—Ä—ñ—Ç—å —É—á–Ω—ñ–≤ –∑—ñ —Å–ø–∏—Å–∫—É –Ω–∏–∂—á–µ ‚Äî –≤–æ–Ω–∏ –∑\'—è–≤–ª—è—Ç—å—Å—è —É ‚Äú–ú–æ—ó —É—á–Ω—ñ‚Äù.'
                : '–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —É—á–Ω—ñ–≤ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è (–≤—Å—ñ –≤–∂–µ —É –≤–∞—à–æ–º—É —Å–ø–∏—Å–∫—É).';

            if (!available.length) {
                container.innerHTML = '<p style="color:#999; font-size: 12px;">–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π.</p>';
                return;
            }

            container.innerHTML = available.map(s => `
                <div style="padding: 8px; display: flex; gap: 10px; align-items: center;">
                    <input type="checkbox" id="addTeacherStudent_${s.id}" value="${s.id}">
                    <label for="addTeacherStudent_${s.id}" style="cursor: pointer;">${escapeHtml(s.name)} (${escapeHtml(s.email)})</label>
                </div>
            `).join('');
        }

        function saveAddedStudentsToTeacher(e) {
            e.preventDefault();
            const selected = Array.from(document.querySelectorAll('#addTeacherStudentsCheckboxes input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            if (!selected.length) {
                alert('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω–æ–≥–æ —É—á–Ω—è.');
                return;
            }

            if (!appData.users[currentUser.id].students) appData.users[currentUser.id].students = [];
            const existing = new Set(appData.users[currentUser.id].students);
            selected.forEach(id => existing.add(id));

            appData.users[currentUser.id].students = Array.from(existing);
            currentUser.students = appData.users[currentUser.id].students;

            closeModal('addStudentToTeacherModal');
            renderTeacherStudentsList();
            alert('–£—á–Ω—ñ–≤ –¥–æ–¥–∞–Ω–æ!');
        }

        // ========================
        //  STUDENT
        // ========================
        function renderStudentView() {
            renderMySchedule();
            renderMyAssignments();
            renderMyMaterials();
        }

        function renderMySchedule() {
            if (!window.studentSelectedDate) {
                const today = new Date();
                window.studentSelectedDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
                window.studentCalendarMonth = today.getMonth();
                window.studentCalendarYear = today.getFullYear();
            }
            renderStudentCalendarView();
        }

        function renderStudentCalendarView() {
            const currentMonth = window.studentCalendarMonth;
            const currentYear = window.studentCalendarYear;
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            const monthNames = ['–°—ñ—á–µ–Ω—å','–õ—é—Ç–∏–π','–ë–µ—Ä–µ–∑–µ–Ω—å','–ö–≤—ñ—Ç–µ–Ω—å','–¢—Ä–∞–≤–µ–Ω—å','–ß–µ—Ä–≤–µ–Ω—å','–õ–∏–ø–µ–Ω—å','–°–µ—Ä–ø–µ–Ω—å','–í–µ—Ä–µ—Å–µ–Ω—å','–ñ–æ–≤—Ç–µ–Ω—å','–õ–∏—Å—Ç–æ–ø–∞–¥','–ì—Ä—É–¥–µ–Ω—å'];
            const dayNames = ['–ù–¥','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];

            const studentSchedule = appData.schedule.filter(s => (s.studentIds || []).includes(currentUser.id));
            const scheduledDates = new Set(studentSchedule.map(s => s.date));

            let calendarHtml = `
                <div class="calendar">
                    <div class="calendar-header">
                        <div class="calendar-controls">
                            <button type="button" onclick="changeStudentMonth(-1)">‚Üê</button>
                            <span>${monthNames[currentMonth]} ${currentYear}</span>
                            <button type="button" onclick="changeStudentMonth(1)">‚Üí</button>
                        </div>
                    </div>
                    <div class="weekdays">
                        ${dayNames.map(day => `<div class="weekday">${day}</div>`).join('')}
                    </div>
                    <div class="days">
            `;

            const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                calendarHtml += `<div class="day other-month">${prevMonthLastDay - i}</div>`;
            }

            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const hasSchedule = scheduledDates.has(dateStr);
                const isSelected = window.studentSelectedDate === dateStr;
                const isToday = dateStr === todayStr;

                calendarHtml += `<div class="day ${isSelected ? 'selected' : ''} ${hasSchedule ? 'has-schedule' : ''}" onclick="selectStudentScheduleDate('${dateStr}')" style="${isToday ? 'border: 2px solid var(--color-primary);' : ''}">${day}</div>`;
            }

            const totalCells = Math.ceil((startingDayOfWeek + daysInMonth) / 7) * 7;
            for (let day = 1; day <= totalCells - startingDayOfWeek - daysInMonth; day++) {
                calendarHtml += `<div class="day other-month">${day}</div>`;
            }

            calendarHtml += `</div></div>`;

            const dateObj = new Date(window.studentSelectedDate + 'T00:00:00');
            const dayNames2 = ['–Ω–µ–¥—ñ–ª—è','–ø–æ–Ω–µ–¥—ñ–ª–æ–∫','–≤—ñ–≤—Ç–æ—Ä–æ–∫','—Å–µ—Ä–µ–¥–∞','—á–µ—Ç–≤–µ—Ä','–ø\'—è—Ç–Ω–∏—Ü—è','—Å—É–±–æ—Ç–∞'];
            const monthNames2 = ['—Å—ñ—á–Ω—è','–ª—é—Ç–æ–≥–æ','–±–µ—Ä–µ–∑–Ω—è','–∫–≤—ñ—Ç–Ω—è','—Ç—Ä–∞–≤–Ω—è','—á–µ—Ä–≤–Ω—è','–ª–∏–ø–Ω—è','—Å–µ—Ä–ø–Ω—è','–≤–µ—Ä–µ—Å–Ω—è','–∂–æ–≤—Ç–Ω—è','–ª–∏—Å—Ç–æ–ø–∞–¥–∞','–≥—Ä—É–¥–Ω—è'];
            const dayName = dayNames2[dateObj.getDay()];
            const monthName = monthNames2[dateObj.getMonth()];
            const day = dateObj.getDate();

            const studentScheduleForDay = studentSchedule.filter(s => s.date === window.studentSelectedDate);
            let scheduleHtml = `<div class="schedule-day-header">${dayName}, ${day} ${monthName}</div>`;

            if (studentScheduleForDay.length === 0) {
                scheduleHtml += '<p style="color: #999;">–ù–∞ —Ü–µ–π –¥–µ–Ω—å –∑–∞–Ω—è—Ç—å –Ω–µ–º–∞—î</p>';
            } else {
                scheduleHtml += studentScheduleForDay.map(sched => {
                    const teacher = appData.users[sched.teacherId];
                    return `
                        <div class="schedule-item">
                            <div class="schedule-info">
                                <strong>${escapeHtml(sched.name)}</strong>
                                <small>${escapeHtml(sched.time)}</small>
                                <small style="color: var(--color-primary); display: block; margin-top: 4px;">–í–∏–∫–ª–∞–¥–∞—á: ${teacher ? escapeHtml(teacher.name) : 'N/A'}</small>
                            </div>
                            <div class="schedule-platform" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                                <span class="badge badge-platform">${escapeHtml(sched.platform)}</span>
                                ${sched.link ? `<a href="${escapeHtml(sched.link)}" target="_blank" rel="noopener" style="color: var(--color-primary); text-decoration: underline;">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</a>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            const card = document.querySelector('#mySchedule .card');
            card.innerHTML = `<h3>–†–æ–∑–∫–ª–∞–¥ –∑–∞–Ω—è—Ç—å</h3><div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">${calendarHtml}<div>${scheduleHtml}</div></div>`;
        }

        function changeStudentMonth(offset) {
            window.studentCalendarMonth += offset;
            if (window.studentCalendarMonth > 11) { window.studentCalendarMonth = 0; window.studentCalendarYear++; }
            else if (window.studentCalendarMonth < 0) { window.studentCalendarMonth = 11; window.studentCalendarYear--; }
            renderStudentCalendarView();
        }

        function selectStudentScheduleDate(dateStr) {
            window.studentSelectedDate = dateStr;
            renderStudentCalendarView();
        }

        function renderMyAssignments() {
            const list = document.getElementById('myAssignmentsList');
            const myAssignments = appData.assignments.filter(assign => {
                const ids = assign.studentIds || [];
                if (ids.length > 0) return ids.includes(currentUser.id);
                return assign.studentStatus && assign.studentStatus[currentUser.id] !== undefined;
            });

            list.innerHTML = myAssignments.map(assign => {
                const status = (assign.studentStatus && assign.studentStatus[currentUser.id]) ? assign.studentStatus[currentUser.id] : 'not_started';
                const linked = assign.linkedLessonId ? appData.schedule.find(x => x.id === assign.linkedLessonId) : null;
                return `
                    <div class="assignment">
                        <h4>${escapeHtml(assign.title)}</h4>
                        <p>${escapeHtml(assign.description || '')}</p>
                        <div class="assignment-meta">
                            <small>üìÖ –ö—Ä–∞–π–Ω—ñ–π —Ç–µ—Ä–º—ñ–Ω: ${assign.deadline ? formatDateUA(assign.deadline) : '-'}</small>
                            <small>–°—Ç–∞—Ç—É—Å: <span class="status-${escapeHtml(status)}">${getStatusLabel(status)}</span></small>
                            ${linked ? `<small>üîó ${formatDateUA(linked.date)} ‚Ä¢ ${escapeHtml(linked.name)}</small>` : ''}
                        </div>

                        ${assign.teacherFiles && assign.teacherFiles.length ? `
                            <div style="background:#fff; border: 1px dashed var(--color-border); padding: 10px; border-radius: var(--radius); margin-bottom: 12px;">
                                <strong style="font-size: 12px;">üìé –§–∞–π–ª–∏ –≤—ñ–¥ –≤–∏–∫–ª–∞–¥–∞—á–∞:</strong>
                                <div class="muted" style="margin-top: 6px;">${assign.teacherFiles.map(escapeHtml).join(', ')}</div>
                            </div>
                        ` : ''}

                        ${assign.studentComments && assign.studentComments[currentUser.id] ? `
                            <div style="background: #f0f9ff; padding: 12px; border-radius: var(--radius); border-left: 4px solid var(--color-info); margin-bottom: 12px;">
                                <strong>üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä –≤–∏–∫–ª–∞–¥–∞—á–∞:</strong>
                                <p style="margin: 8px 0 0 0;">${escapeHtml(assign.studentComments[currentUser.id])}</p>
                            </div>
                        ` : ''}

                        <div class="assignment-actions">
                            <button class="btn-small btn-small-primary" type="button" onclick="openAssignmentDetail('${assign.id}')">üìÇ –í—ñ–¥–∫—Ä–∏—Ç–∏</button>
                            <button class="btn-small btn-small-secondary" type="button" onclick="openSubmitAssignmentModal('${assign.id}')">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç–∏</button>
                        </div>
                    </div>
                `;
            }).join('') || '<p style="color: #999;">–ó–∞–≤–¥–∞–Ω—å –Ω–µ–º–∞—î</p>';
        }

        function renderMyMaterials() {
            const list = document.getElementById('myMaterialsList');
            const materials = appData.studentMaterials[currentUser.id] || [];

            list.innerHTML = materials.map(material => {
                const linked = material.scheduleId ? appData.schedule.find(s => s.id === material.scheduleId) : null;
                return `
                    <div class="card" style="margin-bottom: 15px;">
                        <h4 style="color: var(--color-primary); margin: 0 0 8px 0;">${escapeHtml(material.title)}</h4>
                        <small style="color: var(--color-text-light); display: block; margin-bottom: 8px;">üìÖ ${material.date ? formatDateUA(material.date) : ''}</small>
                        ${linked ? `<small class="muted" style="display:block; margin-bottom: 8px;">üîó –î–æ –∑–∞–Ω—è—Ç—Ç—è: ${formatDateUA(linked.date)} ‚Ä¢ ${escapeHtml(linked.name)}</small>` : ''}
                        ${material.description ? `<p style="margin: 8px 0;">${escapeHtml(material.description)}</p>` : ''}
                        ${material.files && material.files.length ? `
                            <div style="background: #f9f9f9; padding: 12px; border-radius: var(--radius); margin-top: 10px;">
                                <strong style="font-size: 12px;">üìé –§–∞–π–ª–∏:</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                    ${material.files.map(f => `<li style="font-size: 12px; margin-bottom: 4px;">${escapeHtml(f)}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('') || '<p style="color: #999;">–ú–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ –Ω–µ–º–∞—î</p>';
        }

        // Student assignment modals
        let currentAssignmentId = null;

        function openAssignmentDetail(assignmentId) {
            const assignment = appData.assignments.find(a => a.id === assignmentId);
            if (!assignment) return;
            currentAssignmentId = assignmentId;

            document.getElementById('assignDetailTitle').textContent = assignment.title;

            const status = (assignment.studentStatus && assignment.studentStatus[currentUser.id]) ? assignment.studentStatus[currentUser.id] : 'not_started';
            const submission = assignment.studentSubmissions ? assignment.studentSubmissions[currentUser.id] : null;
            const teacherComment = assignment.studentComments ? assignment.studentComments[currentUser.id] : '';

            let html = `
                <p><strong>–û–ø–∏—Å:</strong> ${escapeHtml(assignment.description || '')}</p>
                <p><strong>–ö—Ä–∞–π–Ω—ñ–π —Ç–µ—Ä–º—ñ–Ω:</strong> ${escapeHtml(assignment.deadline || '')}</p>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getStatusLabel(status)}</p>
            `;

            if (assignment.teacherFiles && assignment.teacherFiles.length) {
                html += `
                    <div style="background:#fff; border: 1px dashed var(--color-border); padding: 10px; border-radius: var(--radius); margin: 12px 0;">
                        <strong style="font-size: 12px;">üìé –§–∞–π–ª–∏ –≤—ñ–¥ –≤–∏–∫–ª–∞–¥–∞—á–∞:</strong>
                        <div class="muted" style="margin-top: 6px;">${assignment.teacherFiles.map(escapeHtml).join(', ')}</div>
                    </div>
                `;
            }

            if (teacherComment) {
                html += `
                    <div style="background: #f0f9ff; padding: 12px; border-radius: var(--radius); border-left: 4px solid var(--color-info); margin: 12px 0;">
                        <strong>üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä –≤–∏–∫–ª–∞–¥–∞—á–∞:</strong>
                        <p style="margin: 8px 0 0 0;">${escapeHtml(teacherComment)}</p>
                    </div>
                `;
            }

            if (submission) {
                html += `
                    <div style="background: #f9f9f9; padding: 15px; border-radius: var(--radius); margin-top: 15px;">
                        <h4 style="color: var(--color-primary); margin-bottom: 10px;">üì§ –í–∞—à–µ —Ä—ñ—à–µ–Ω–Ω—è</h4>
                        <p><strong>–î–∞—Ç–∞ –∑–¥–∞—á—ñ:</strong> ${escapeHtml(submission.date || '')}</p>
                        ${submission.text ? `<p><strong>–¢–µ–∫—Å—Ç:</strong><br>${escapeHtml(String(submission.text)).replace(/\n/g, '<br>')}</p>` : ''}
                        ${submission.files && submission.files.length ? `
                            <div style="margin-top: 10px;">
                                <strong>üìé –§–∞–π–ª–∏:</strong>
                                <ul style="margin: 5px 0 0 0; padding-left: 20px;">
                                    ${submission.files.map(file => `<li>${escapeHtml(file)}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            document.getElementById('assignDetailContent').innerHTML = html;
            document.getElementById('assignmentDetailModal').classList.add('active');
        }

        function openSubmitAssignmentModal(assignmentId) {
            currentAssignmentId = assignmentId;
            document.getElementById('solutionText').value = '';
            document.getElementById('solutionFiles').value = '';
            document.getElementById('uploadedFilesList').innerHTML = '';
            document.getElementById('submitAssignmentModal').classList.add('active');
        }

        function submitAssignmentSolution(e) {
            e.preventDefault();
            const assignment = appData.assignments.find(a => a.id === currentAssignmentId);
            if (!assignment) return;

            if (!assignment.studentSubmissions) assignment.studentSubmissions = {};
            if (!assignment.studentStatus) assignment.studentStatus = {};
            if (!assignment.studentComments) assignment.studentComments = {};

            const files = document.getElementById('solutionFiles').files;
            const fileNames = Array.from(files).map(f => f.name);

            assignment.studentSubmissions[currentUser.id] = {
                text: document.getElementById('solutionText').value,
                files: fileNames,
                date: new Date().toLocaleDateString('uk-UA')
            };
            assignment.studentStatus[currentUser.id] = 'in_progress';

            closeModal('submitAssignmentModal');
            renderMyAssignments();
            alert('–†—ñ—à–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!');
        }

        // ========================
        //  SELF-TESTS
        // ========================
        function runSelfTests() {
            const assert = (name, cond) => { if (!cond) throw new Error('Test failed: ' + name); };

            assert('newline replace works', 'a\nb'.replace(/\n/g, '<br>') === 'a<br>b');
            assert('validateEmail ok', validateEmail('a@b.com') === true);
            assert('validateEmail bad', validateEmail('a@b') === false);
            assert('getLessonsForStudent returns sched_1 for student_1', getLessonsForStudent('teacher_001', 'student_1').some(x => x.id === 'sched_1'));
            assert('teacher_001 canAddStudents demo', appData.users['teacher_001'].canAddStudents === true);

            // Added tests
            assert('escapeHtml escapes tags', escapeHtml('<b>') === '&lt;b&gt;');
            assert('demo user exists', !!findDemoUser('admin@example.com', 'demo123'));
            assert('openPasswordResetModal exists', typeof openPasswordResetModal === 'function');

            const hEl = document.getElementById('schedHour');
            const mEl = document.getElementById('schedMinute');
            if (hEl && mEl) {
                hEl.value = '09';
                mEl.value = '15';
                assert('getTimeFromPickers 24h', getTimeFromPickers() === '09:15');
                setTimePickers('21:05');
                assert('setTimePickers sets hour', document.getElementById('schedHour').value === '21');
                setTimePickers('21:58');
                assert('setTimePickers snaps minutes to 55 max', document.getElementById('schedMinute').value === '55');
            }

            assert('supabase configured is false by default', isSupabaseConfigured() === false);
            assert('getSupabaseClient returns null by default', getSupabaseClient() === null);
        }

        // Better console errors than generic "Script error."
        window.addEventListener('error', (e) => {
            try {
                if (e?.error) console.error(e.error);
                else console.error(e?.message || e);
            } catch (_) {}
        });
        window.addEventListener('unhandledrejection', (e) => {
            try { console.error('Unhandled rejection:', e?.reason || e); } catch (_) {}
        });

        // Quick diagnostics helper (run in DevTools console: debugAuth())
        window.debugAuth = async function debugAuth() {
            const client = getSupabaseClient();
            if (!client) {
                console.log('Supabase is not configured/loaded');
                return;
            }
            const { data: u } = await client.auth.getUser();
            const email = u?.user?.email;
            let profile = null;
            try {
                profile = u?.user?.id ? await getMyProfile(u.user.id) : null;
            } catch (e) {
                console.warn('getMyProfile failed:', e);
            }
            console.log({
                OWNER_EMAIL,
                email,
                isOwner: isOwnerEmail(email),
                profile,
                currentUser
            });
        };

        // ========================
        //  INIT
        // ========================
        document.addEventListener('DOMContentLoaded', () => {
            // show a one-time success after password update
            try {
                if (sessionStorage.getItem('pw_updated') === '1') {
                    sessionStorage.removeItem('pw_updated');
                    const err = document.getElementById('loginError');
                    if (err) err.innerHTML = '<div class="success-message">–ü–∞—Ä–æ–ª—å –∑–º—ñ–Ω–µ–Ω–æ ‚úÖ –¢–µ–ø–µ—Ä —É–≤—ñ–π–¥—ñ—Ç—å –∑ –Ω–æ–≤–∏–º –ø–∞—Ä–æ–ª–µ–º.</div>';
                }
            } catch (_) {}

            // Wire buttons/links (fallback even if inline handlers are blocked)
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) loginBtn.addEventListener('click', () => login());
            const regBtn = document.getElementById('registerBtn');
            if (regBtn) regBtn.addEventListener('click', () => register());
            const toReg = document.getElementById('toRegisterLink');
            if (toReg) toReg.addEventListener('click', (e) => { e.preventDefault(); toggleAuth(); });
            const toLogin = document.getElementById('toLoginLink');
            if (toLogin) toLogin.addEventListener('click', (e) => { e.preventDefault(); toggleAuth(); });
            const forgot = document.getElementById('forgotPwdLink');
            if (forgot) forgot.addEventListener('click', (e) => { e.preventDefault(); openPasswordResetModal(false); });

            // Supabase setup UI
            const setup = document.getElementById('supabaseSetup');
            const { url: cfgUrl, key: cfgKey } = getSupabaseConfig();
            const sbUrl = document.getElementById('sbUrl');
            const sbAnon = document.getElementById('sbAnon');
            if (sbUrl) sbUrl.value = (cfgUrl && !cfgUrl.includes('PASTE_')) ? cfgUrl : '';
            if (sbAnon) sbAnon.value = (cfgKey && !cfgKey.includes('PASTE_')) ? cfgKey : '';

            const saveBtn = document.getElementById('saveSupabaseBtn');
            const clearBtn = document.getElementById('clearSupabaseBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    const u = (sbUrl?.value || '').trim();
                    const k = (sbAnon?.value || '').trim();
                    if (!u.startsWith('http') || !k.startsWith('ey')) {
                        const err = document.getElementById('loginError');
                        if (err) err.innerHTML = '<div class="error-message">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ URL —Ç–∞ anon key (–º–∞—é—Ç—å –ø–æ—á–∏–Ω–∞—Ç–∏—Å—è –∑ https:// —Ç–∞ ey...)</div>';
                        return;
                    }
                    try {
                        localStorage.setItem('sb_url', u);
                        localStorage.setItem('sb_anon', k);
                    } catch (_) {}
                    location.reload();
                });
            }
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    try {
                        localStorage.removeItem('sb_url');
                        localStorage.removeItem('sb_anon');
                    } catch (_) {}
                    location.reload();
                });
            }

            // Show setup block when not configured
            if (setup) setup.style.display = isSupabaseConfigured() ? 'none' : 'block';

            // initial renders so admin dashboard doesn't look empty in demo
            renderUsersList();
            renderAllAssignments();

            // start auth bootstrap AFTER all functions exist
            bootstrapAuth();

            if (new URLSearchParams(location.search).get('test') === '1') {
                runSelfTests();
                console.log('‚úÖ Self-tests passed');
            }
        });
    </script>
</body>
</html>
